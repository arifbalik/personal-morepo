
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="My every personal project in one repo">
      
      
        <meta name="author" content="Arif Balik">
      
      
        <link rel="canonical" href="https://arifbalik.github.io/self-monorepo/zephyr-device-driver/">
      
      
        <link rel="prev" href="..">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>A Practical Guide to Zephyr Device Driver Development - Self Monorepo</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#a-practical-guide-to-zephyr-device-driver-development" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Self Monorepo" class="md-header__button md-logo" aria-label="Self Monorepo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Self Monorepo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              A Practical Guide to Zephyr Device Driver Development
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Self Monorepo" class="md-nav__button md-logo" aria-label="Self Monorepo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Self Monorepo
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog Posts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Zephyr device driver
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Zephyr device driver
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    A Practical Guide to Zephyr Device Driver Development
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    A Practical Guide to Zephyr Device Driver Development
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites-and-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites and Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites and Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-container" class="md-nav__link">
    <span class="md-ellipsis">
      Using the container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vscode-remote-containers" class="md-nav__link">
    <span class="md-ellipsis">
      VSCode Remote Containers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-container-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Building the container (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#west-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      West Workspaces
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-driver-development" class="md-nav__link">
    <span class="md-ellipsis">
      Device Driver Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Driver Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Hardware
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Hardware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#surface-charge-transfer" class="md-nav__link">
    <span class="md-ellipsis">
      Surface Charge Transfer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registers-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Registers and Configurations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Registers and Configurations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reset-and-clock-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Reset and Clock Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpio-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      GPIO Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-clock-prescaler-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Clock Prescaler Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-pulse-generator-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Pulse Generator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-spread-spectrum-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Spread Spectrum Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-sync-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC SYNC Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Interrupts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-read-the-count-value" class="md-nav__link">
    <span class="md-ellipsis">
      How to Read the Count Value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-tree-nodes-and-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Device Tree Nodes and Bindings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Tree Nodes and Bindings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pin-control" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Other Bindings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Other Bindings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pulse-generator-prescaler" class="md-nav__link">
    <span class="md-ellipsis">
      Pulse Generator Prescaler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#charge-transfer-pulse-high-and-low" class="md-nav__link">
    <span class="md-ellipsis">
      Charge Transfer Pulse High and Low
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-count-value" class="md-nav__link">
    <span class="md-ellipsis">
      Max Count Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spread-spectrum" class="md-nav__link">
    <span class="md-ellipsis">
      Spread Spectrum
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-signal" class="md-nav__link">
    <span class="md-ellipsis">
      SYNC Signal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io-default-mode" class="md-nav__link">
    <span class="md-ellipsis">
      IO Default Mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#child-nodes-and-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Child Nodes and Bindings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-binding-file-and-device-tree-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Final Binding File and Device Tree Nodes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plumbing-device-tree-to-driver-code" class="md-nav__link">
    <span class="md-ellipsis">
      Plumbing Device Tree to Driver Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plumbing Device Tree to Driver Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-tree-macros" class="md-nav__link">
    <span class="md-ellipsis">
      Device Tree Macros
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-base-address" class="md-nav__link">
    <span class="md-ellipsis">
      Register Base Address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clock-and-reset-control" class="md-nav__link">
    <span class="md-ellipsis">
      Clock and Reset Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Group Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    <span class="md-ellipsis">
      Putting it all together
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting it all together">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Device Driver Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Driver Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peripheral-and-subsystem-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Peripheral and Subsystem APIs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset-api" class="md-nav__link">
    <span class="md-ellipsis">
      Reset API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clock-control-api" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Control API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-controller-api" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Controller API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_init" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-peripheral-api" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Peripheral API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-peripheral-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Peripheral API Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TSC Peripheral API Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_start" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_poll_for_acquisition" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_poll_for_acquisition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_read" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_isr" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_isr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-into-the-build-system" class="md-nav__link">
    <span class="md-ellipsis">
      Integration into the Build System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration into the Build System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      Source CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source-kconfig" class="md-nav__link">
    <span class="md-ellipsis">
      Source Kconfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zephyr-cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      Zephyr CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zephyr-kconfig" class="md-nav__link">
    <span class="md-ellipsis">
      Zephyr Kconfig
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-we-test-this" class="md-nav__link">
    <span class="md-ellipsis">
      How Do We Test This?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How Do We Test This?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    <span class="md-ellipsis">
      Building
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flashing" class="md-nav__link">
    <span class="md-ellipsis">
      Flashing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flashing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    <span class="md-ellipsis">
      Windows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#osx" class="md-nav__link">
    <span class="md-ellipsis">
      OSX
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-to-test" class="md-nav__link">
    <span class="md-ellipsis">
      What to Test?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Test Plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-application" class="md-nav__link">
    <span class="md-ellipsis">
      Test Application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prjconf" class="md-nav__link">
    <span class="md-ellipsis">
      prj.conf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-tree-overlays" class="md-nav__link">
    <span class="md-ellipsis">
      Device tree overlays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testcaseyml" class="md-nav__link">
    <span class="md-ellipsis">
      testcase.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Test Cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Test Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first-test-case" class="md-nav__link">
    <span class="md-ellipsis">
      First Test Case
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-mmio" class="md-nav__link">
    <span class="md-ellipsis">
      Test MMIO
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-tests" class="md-nav__link">
    <span class="md-ellipsis">
      API Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running the Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapping-up" class="md-nav__link">
    <span class="md-ellipsis">
      Wrapping Up
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites-and-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites and Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites and Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-container" class="md-nav__link">
    <span class="md-ellipsis">
      Using the container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vscode-remote-containers" class="md-nav__link">
    <span class="md-ellipsis">
      VSCode Remote Containers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-container-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Building the container (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#west-workspaces" class="md-nav__link">
    <span class="md-ellipsis">
      West Workspaces
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-driver-development" class="md-nav__link">
    <span class="md-ellipsis">
      Device Driver Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Driver Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Hardware
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Hardware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#surface-charge-transfer" class="md-nav__link">
    <span class="md-ellipsis">
      Surface Charge Transfer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registers-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Registers and Configurations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Registers and Configurations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reset-and-clock-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Reset and Clock Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpio-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      GPIO Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-clock-prescaler-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Clock Prescaler Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-pulse-generator-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Pulse Generator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-spread-spectrum-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Spread Spectrum Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-sync-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC SYNC Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Interrupts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-read-the-count-value" class="md-nav__link">
    <span class="md-ellipsis">
      How to Read the Count Value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-tree-nodes-and-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Device Tree Nodes and Bindings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Tree Nodes and Bindings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pin-control" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Other Bindings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Other Bindings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pulse-generator-prescaler" class="md-nav__link">
    <span class="md-ellipsis">
      Pulse Generator Prescaler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#charge-transfer-pulse-high-and-low" class="md-nav__link">
    <span class="md-ellipsis">
      Charge Transfer Pulse High and Low
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-count-value" class="md-nav__link">
    <span class="md-ellipsis">
      Max Count Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spread-spectrum" class="md-nav__link">
    <span class="md-ellipsis">
      Spread Spectrum
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-signal" class="md-nav__link">
    <span class="md-ellipsis">
      SYNC Signal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io-default-mode" class="md-nav__link">
    <span class="md-ellipsis">
      IO Default Mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#child-nodes-and-bindings" class="md-nav__link">
    <span class="md-ellipsis">
      Child Nodes and Bindings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-binding-file-and-device-tree-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Final Binding File and Device Tree Nodes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plumbing-device-tree-to-driver-code" class="md-nav__link">
    <span class="md-ellipsis">
      Plumbing Device Tree to Driver Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plumbing Device Tree to Driver Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-tree-macros" class="md-nav__link">
    <span class="md-ellipsis">
      Device Tree Macros
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-base-address" class="md-nav__link">
    <span class="md-ellipsis">
      Register Base Address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clock-and-reset-control" class="md-nav__link">
    <span class="md-ellipsis">
      Clock and Reset Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#group-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Group Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    <span class="md-ellipsis">
      Putting it all together
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting it all together">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Interrupts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-driver-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Device Driver Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Device Driver Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peripheral-and-subsystem-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Peripheral and Subsystem APIs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reset-api" class="md-nav__link">
    <span class="md-ellipsis">
      Reset API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clock-control-api" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Control API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-controller-api" class="md-nav__link">
    <span class="md-ellipsis">
      Pin Controller API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_init" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-peripheral-api" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Peripheral API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-peripheral-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      TSC Peripheral API Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TSC Peripheral API Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_start" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_poll_for_acquisition" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_poll_for_acquisition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_read" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stm32_tsc_isr" class="md-nav__link">
    <span class="md-ellipsis">
      stm32_tsc_isr
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-into-the-build-system" class="md-nav__link">
    <span class="md-ellipsis">
      Integration into the Build System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration into the Build System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      Source CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source-kconfig" class="md-nav__link">
    <span class="md-ellipsis">
      Source Kconfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zephyr-cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      Zephyr CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zephyr-kconfig" class="md-nav__link">
    <span class="md-ellipsis">
      Zephyr Kconfig
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-we-test-this" class="md-nav__link">
    <span class="md-ellipsis">
      How Do We Test This?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How Do We Test This?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    <span class="md-ellipsis">
      Building
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flashing" class="md-nav__link">
    <span class="md-ellipsis">
      Flashing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Flashing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    <span class="md-ellipsis">
      Windows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#osx" class="md-nav__link">
    <span class="md-ellipsis">
      OSX
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-to-test" class="md-nav__link">
    <span class="md-ellipsis">
      What to Test?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Test Plan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-application" class="md-nav__link">
    <span class="md-ellipsis">
      Test Application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cmakeliststxt" class="md-nav__link">
    <span class="md-ellipsis">
      CMakeLists.txt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prjconf" class="md-nav__link">
    <span class="md-ellipsis">
      prj.conf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-tree-overlays" class="md-nav__link">
    <span class="md-ellipsis">
      Device tree overlays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testcaseyml" class="md-nav__link">
    <span class="md-ellipsis">
      testcase.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Test Cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Test Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first-test-case" class="md-nav__link">
    <span class="md-ellipsis">
      First Test Case
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-mmio" class="md-nav__link">
    <span class="md-ellipsis">
      Test MMIO
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-tests" class="md-nav__link">
    <span class="md-ellipsis">
      API Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running the Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapping-up" class="md-nav__link">
    <span class="md-ellipsis">
      Wrapping Up
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="a-practical-guide-to-zephyr-device-driver-development">A Practical Guide to Zephyr Device Driver Development <!-- omit from toc --></h1>
<p>This is a guide on how to write a production grade device driver in Zephyr. This includes driver code, testing, CI and many more. Do not consider this document as a tutorial to Zephyr or device drivers, I'll just showcase my workflow and the environment I use to develop device drivers in Zephyr. Some of this may not be suited for your workflow, but I'll try to keep each section on it's own so you can skip the parts you don't need or don't want to use.</p>
<p>I'll not talk about some details and assume you have at least heard about Zephyr and device drivers. If you don't, or want to refresh your memory check out the <a href="https://docs.zephyrproject.org/latest/">official documentation</a>. More of the talk will assume you were already developing on embedded projects and want to try something new, or you are already developing on Zephyr and want to see how others do it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Zephyr still makes big changes to the framework, so some of the information here might be outdated or not the best practice anymore. I'll try to keep this up to date as much as possible, and give version information anywhere I can. Also I'll run inside a development container for you readers to easily follow along.
</p>
</div>
<h2 id="introduction">Introduction</h2>
<p>I've known about Zephyr for a while now but only had the chance to work with it by the beginning of this year when I listened the <a href="https://theamphour.com/653-benjamin-cabe-nose-zephyr/">this Amp Hour podcast</a>. I've quickly come to realize the enormous benefits of using Zephyr for any kind of embedded project. From full blown RTOS running on x86 with network stacks and PCIe drivers to a microcontroller with 32KB of flash, Zephyr is a great choice for any project. It was surreal to edit <a href="https://www.devicetree.org/">devicetree</a> files to configure a 50-cent microcontroller.</p>
<p>Zephyr gives you a nice framework for everything embedded. You have device trees, device drivers, networking stacks, filesystems, a testing framework, a nice RTOS, a nice build system and anything else you can name. It abstracts low level hardware so nicely that you only need to write what your application ultimately wants to do in a hardware-agnostic way and have it run on anything without touching a single line of code.</p>
<p>I especially liked the Zephyr because I was working on a range of similar products with an unorganized and distributed codebase, we needed to run our business logic on slightly different hardware platforms, so the device driver model and device trees was the perfect solution in this case. We initially got concerned about the size of the firmware as we were on very tight budget, we could only get 32KB and 64KB flash microcontrollers, and Zephyr seemed overkill for this, but it was not. It seems like the Zephyr team has a lot of experience in the embedded world and Linux in general, so they've made the right choice of making the entire thing customizable down to the detail. If you strip down everything you can get down to a ~3KB binary, which is amazing. But most of the time you want to use OS services and other features so you end up with a <a href="https://docs.zephyrproject.org/latest/samples/basic/minimal/README.html">~7KB-10KB binary for a minimal application</a>.</p>
<p>Most of the drivers are already in the Zephyr upstream, but you eventually have to write your own device drivers for your custom hardware. That's what I ended up doing, writing some device drivers, generating my custom board configurations and device trees, and wrote my application logic, and here I'll show you how I did it.</p>
<h2 id="prerequisites-and-setup">Prerequisites and Setup</h2>
<p>First of all we need an environment to work in. In this environment we'll have all the tools we need to develop, test and debug our device driver. I usually prefer working in docker containers for reproducibility and ease of deployment. Therefore you need some tools installed in your host to get started.</p>
<ul>
<li><a href="https://www.docker.com/">Docker</a> (v26.0.0)</li>
<li><a href="https://code.visualstudio.com/">VSCode</a> (v1.92.0)</li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers">Remote - Containers</a> extension for VSCode (v0.389.0)</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I'm running on a x86 Windows machine, so I can use things like <a href="https://usbip.sourceforge.net/">USBIP</a> to debug my hardware connected to my host but this feature is not yet available in macOS, but we will also discuss about remote debugging in later sections.</p>
</div>
<p>I assume most of you already have those installed, so lets quickly get started.</p>
<h3 id="setup">Setup</h3>
<p>If you are using VSCode, you can use devcontainers feature to get your development environment up and running in no time. But you can also use any other editor or a terminal to do everything I'll show you here.</p>
<p>If you want to work on your host machine, you can check out the <a href="https://docs.zephyrproject.org/latest/getting_started/index.html">official Zephyr documentation</a> to setup your environment.</p>
<p>The development container is based on official <code>zephyr-build</code> container in <a href="https://github.com/zephyrproject-rtos/docker-image">Zephyr's <code>docker-image</code> repository</a>. I've added extra configurations to really integrate it into VSCode with extensions and tools. But basically it has:</p>
<ul>
<li>Zephyr SDK (0.16.8)</li>
<li>All the system packages needed for Zephyr</li>
<li>Python3 and pip packages (including <a href="https://docs.zephyrproject.org/latest/develop/west/index.html">west</a>)</li>
<li>Oh My Zsh</li>
<li>VSCode Extensions</li>
</ul>
<p>Check out the <a href="https://github.com/arifbalik/self-monorepo/blob/main/docs/zephyr-device-driver/.devcontainer/devcontainer.json">devcontainer.json</a> if you want to see the exact setup. To keep it compatible with non-vscode users, I kept the configuration minimal. I highly encourage you to modify the file to your needs. There are tons of customizations you can do with devcontainers.</p>
<h4 id="using-the-container">Using the container</h4>
<p>The fastest way to start is to pull and run the image I prepared from my GitHub Container Registry with the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--name<span class="w"> </span>zephyr-dev<span class="w"> </span>-v<span class="w"> </span>zephyr-volume:/workdir<span class="w"> </span>ghcr.io/arifbalik/zephyr-dev:latest
</span></code></pre></div>
<p>This should drop you into a shell with the Zephyr SDK and all the tools installed.</p>
<h4 id="vscode-remote-containers">VSCode Remote Containers</h4>
<p>Easiest method to work in a container is to use the <code>Remote - Containers</code> extension in VSCode. You can open the project folder in VSCode and click on the blue icon in the bottom left corner or with <code>ctrl + shift + p</code> and select <code>Attach to Running Container...</code> and select the container you just started.</p>
<h4 id="building-the-container-optional">Building the container (optional)</h4>
<p>The building requires additional tools like <a href="https://nodejs.org/en">node</a>, <a href="https://www.npmjs.com/">npm</a> and <a href="https://www.npmjs.com/package/@devcontainers/cli">devcontainers package</a>:</p>
<p>First install the package;</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>@devcontainers/cli
</span></code></pre></div>
<p>Then build the container with the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>devcontainer<span class="w"> </span>up<span class="w"> </span>--config<span class="w"> </span>/path/to/devcontainer.json<span class="w"> </span>--workspace-folder<span class="w"> </span>/path/to/your/workspace
</span></code></pre></div>
<h2 id="getting-started">Getting Started</h2>
<p>Now that we have a system we can build on. We'll use the <code>west</code> tool to get the zephyr repository and start implementing.</p>
<h3 id="west-workspaces">West Workspaces</h3>
<p>Assuming we want to contribute to the open-source project, we will develop inside the Zephyr source, so the T1 topology is what will be used here, but personally I use free standing application workspaces for professional work, T3 topology to be more specific.</p>
<p>Zephyr calls its workspaces <code>west workspaces</code>. And there are 3 main workspace types:</p>
<ul>
<li>Zephyr source as a workspace (T1)</li>
<li>Zephyr application as a workspace (T2)</li>
<li>Custom workspace with multiple Zephyr applications (you guessed it..)</li>
</ul>
<p>More information on them can be found <a href="https://docs.zephyrproject.org/latest/guides/west/workspaces.html">here</a>.</p>
<p>Inside the container, we can start by initializing a workspace with the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>west<span class="w"> </span>init
</span></code></pre></div>
<p>This will create a <code>.west</code> directory and clone zephyr repository into the <code>/workdir</code> which is mounted as volume and its persistent. What also is required is the Zephyr modules and tools, update the workspace with the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>west<span class="w"> </span>update
</span></code></pre></div>
<p>This will fetch all source code that is outside of the Zephyr repository but needed to build an application, like the <code>hal_stm32</code> and <code>mcuboot</code> repositories.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Zephyr version is <code>v3.7.0</code> at the time of writing this document and it has a a bug that has been patched by me but is not in the v3.7.0, therefore if you want to be where I was when this document is written, check out to the <a href="https://github.com/zephyrproject-rtos/zephyr/commit/10fa1eab50ac54e41bf75ab0ad01daa4bd25ba13"><code>10fa1eab50ac54e41bf75ab0ad01daa4bd25ba13</code></a> hash of the <code>zephyr</code> repository, inside <code>zephyr/west.yml</code> file, or apply the patch yourself.</p>
</div>
<p>This may take some time and it will load a ton of modules we won't need, therefore I highly recommend using a T2 or T3 topology for your projects. Once the update is done, a similar file structure should appear in the workspace;</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>.
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w"> </span>bootloader
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w"> </span>modules
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w"> </span>tools
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w"> </span>.west
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w"> </span>zephyr
</span></code></pre></div>
<h2 id="device-driver-development">Device Driver Development</h2>
<p><img alt="STM32U083C Development Kit" src="doc-assets/stm32u083c-dk.jpg" /></p>
<p>Recently I had my hands on a <a href="https://www.st.com/en/evaluation-tools/stm32u083c-dk.html">devkit for STMicroelectronic's U0 series microcontrollers</a>, and one peripheral I was interested was the TSC peripheral in this MCU. This is a peripheral used for capacitive touch sensing applications, buttons, sliders and things like that can be implemented with this peripheral (Notice the touch surface in the bottom right corner, it is a bare electrode and a 1mm insulating surface on top) You can implement a touch sensing application by using a PWM and an ADC maybe with comparator but this peripheral is very simple and does all that and a little bit more and offloads the CPU.</p>
<p>Conveniently Zephyr does not have a driver for this peripheral. So I will write one here.</p>
<h3 id="understanding-the-hardware">Understanding the Hardware</h3>
<p>This section goes a little bit into the details of the hardware we are working with. If you are not interested in this part or you already know the terminology you can skip to the next section.</p>
<p>If you haven't worked with a capacitive touch sensing application before, allow me to tell you that it is not as easy as it seems when integrating touch sensing into a product end-to-end. Especially if you have stricter requirements for your application, like electrically noisy environments, or any industrial spec really immediately starts to complicate things and EMC becomes a big issue.</p>
<p>A capacitive touch point is usually just a piece of conductive material, like a PCB pad. This piece of pad is leveraged to create a capacitive coupling with the human body, so you have to make a sandwich of these two conductive surfaces, (often a plastic is always in between the finger and the plate) forming a capacitor.</p>
<p>Then this means we can charge the capacitor and do funky things with it, for example we can say that the capacitance changes when a finger is present than when it is not, and this can be used to detect a touch.</p>
<p>Of course this is just one very specific setup with a single ended electrode, there are many setups and ways to do this, what we will specifically talk here is called Surface Charge Transfer (SCT) method, which is what this peripheral does.</p>
<h4 id="surface-charge-transfer">Surface Charge Transfer</h4>
<p><img alt="Electrode" src="doc-assets/electrode.png" /></p>
<p>The dotted capacitor in the figure above represents the capacitor of the electrode we just made with a finder and a conductive patch with an insulating layer in between.</p>
<p>This method does not continuously check the voltage of this electrode, instead an external capacitor (in ranges from 1pf to couple hundreds of pf) called <code>sampling capactior</code> is used to transfer some charge in the electrode to this new capacitor (<code>Cs</code> in the figure above), this makes the readings much more repeatable and reliable.</p>
<p>ST TSC in particular calls this combo a <code>group</code> and gives each group two extra channels for more custom applications. Each group has to have 1 sampling capacitor channel and at least one IO channel to function properly. These IO channels do not produce a value each, instead each channel is used to charge the same sampling capacitor, so a group will produce only one count value no matter the IO channel count. ST gives the example of a crude proximity sensor by placing two or more electrodes near each other.</p>
<p><img alt="SCT Method" src="doc-assets/sct.png" /></p>
<p>This charge transfer duration is pretty small (and of course programmable), so it does not fill the sampling capacitor right away, the peripheral needs to perform many of these charge transfer cycles and count it. Counting is stopped when this count reaches a certain threshold, which the peripheral then throws a <code>max count error</code> interrupt, or the voltage on this charged <code>sample</code> capacitor is reached a voltage level (again, programmable) before the max count is reached, peripheral then throws an <code>end of acquisition</code> interrupt which than you can read and find out how many cycles it took to reach this voltage level. And this will directly be correlated to the capacitance of the electrode, which is directly correlated to the presence of a finger.</p>
<p><img alt="STM32 TSC SCT Cycle" src="doc-assets/sct-cycle.png" /></p>
<p>As I mentioned above touch sensing get really messy in noisy environments, so running these cycles and very fast at a fixed interval would not be very wise because the signal would pick up harmonics of the noise and you would get false positives and whatnot. Therefore the peripheral has a feature called <code>spread spectrum</code> which adds variation to charge transfer cycles.</p>
<p>This is a very smart and robust way of detecting a touch. Above you can see the full cycle. I got this image and most of all information about this hardware from the <a href="https://www.st.com/resource/en/reference_manual/rm0503-stm32u0-series-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">reference manual <code>RM0503</code> of the STM32U0 series microcontrollers</a>.</p>
<h3 id="registers-and-configurations">Registers and Configurations</h3>
<p>After we understand the Surface Charge Transfer method we can start to see what can we configure. Functional diagrams is a good way to start.</p>
<p><img alt="STM32 TSC Functional Diagram" src="doc-assets/tsc-functional-diagram.png" /></p>
<p>We can see that we have two different sections which can be clocked at different speeds, one is for generating the charge pulses and other is for spread spectrum which generates a value that feeds into the pulse generator. Something we did not talked about yet is <code>SYNC</code> signal, which is an external signal which triggers pulse generator to start acquisition in addition to the software trigger the driver will use.</p>
<p>Pulse generator commands the IO, setting their modes and function while the acquisition is running and it will store the group results in separate 14-bit values in <code>IOGXCR</code> (IO Group X Counter Register).</p>
<h4 id="reset-and-clock-configuration">Reset and Clock Configuration</h4>
<p>This is a memory mapped peripheral like most all peripherals in STM32 microcontrollers. And often the first thing to do is to reset the peripheral (optional) and enable it. For STM32 MCU's the RCC (Reset and Clock Controller) peripheral is able to do this, so first peripheral to work with is the RCC.</p>
<p>The TSC peripheral gets it's clock from the AHB clock, we expect this clock to be initialized by other drivers, what this driver has to do is to set some bits to perform reset and enable operations. Reference manual gives all the information we would need.</p>
<details>
<p><summary> RCC AHBRSTR (RCC AHB Reset Register Bits 24) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:25</strong></th>
<th style="text-align: center;"><strong>24</strong></th>
<th style="text-align: center;"><strong>23:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">TSCRST</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Touch sensing controller reset</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: No effect<br><code>1</code>: Reset TSC</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
</details>
<details>
<p><summary> RCC AHBENR (RCC AHB Enable Register Bits 24) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:25</strong></th>
<th style="text-align: center;"><strong>24</strong></th>
<th style="text-align: center;"><strong>23:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">TSCEN</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Touch sensing controller clock enable</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: TSC clock disabled<br><code>1</code>: TSC clock enabled</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
</details>
<p>As you can see ST conveniently named the registers and put the relevant bits in the same position for both registers (24th bit). So this means whenever we write 1 to the 24th bit of the <code>RCC register base address + register_offset</code> (<code>0x28</code> for reset and <code>0x48</code> for enable) we can reset and enable the peripheral.</p>
<h4 id="gpio-configuration">GPIO Configuration</h4>
<p>This is the second peripheral before we get to the TSC peripheral. The pins we will use for the TSC should be configured through the GPIO peripheral. Thankfully Zephyr provides a good subsystem and abstraction for this which we will see later.</p>
<p>There is also some registers in the TSC peripheral that we need to configure. First of all we have to specify which channels are used for what, and which groups are enabled. We will use different registers for each of these settings.</p>
<p>When no acquisition is ongoing, the state of the IO channels are in <code>default mode</code>. And TSC peripheral offers an option to set the default mode of the IO channels. This can be floating, push-pull-low. The register for this is <code>CR</code> (Control Register) and the bit position is 4;</p>
<details>
<p><summary> TSC CR (TSC Control Register Bit 4) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:5</strong></th>
<th style="text-align: center;"><strong>4</strong></th>
<th style="text-align: center;"><strong>3:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">IODEF</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">IO default mode</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Push-pull-low<br><code>1</code>: Floating</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
</details>
<p>We use <code>IOCCR</code> (IO Channel Control Register) and <code>IOSCR</code> (IO Sampling Control Register) registers for electrodes and sampling capacitors respectively.</p>
<details>
<p><summary> TSC IOCCR (TSC IO Channel Control Register) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:28</strong></th>
<th style="text-align: center;"><strong>27:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Gx_IOy</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">IO channel y of group x</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: IO used as channel mode</td>
</tr>
</tbody>
</table>
</details>
<details>
<p><summary> TSC IOSCR (TSC IO Sampling Control Register) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:28</strong></th>
<th style="text-align: center;"><strong>27:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Gx_IOy</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">IO channel y of group x</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: IO sampling mode</td>
</tr>
</tbody>
</table>
</details>
<p>And finally <code>IOGCSR</code> (IO Group Control Status Register) to enable the group.</p>
<details>
<p><summary> TSC IOGCSR (TSC IO Group Control Status Register) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:7</strong></th>
<th style="text-align: center;"><strong>6:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">GxS</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Analog I/O group x enable</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: Enabled</td>
</tr>
</tbody>
</table>
</details>
<h4 id="tsc-clock-prescaler-configuration">TSC Clock Prescaler Configuration</h4>
<p>The clock enters the TSC IP from the AHB clock, this clock goes to many other peripherals so it is not a good idea to change the AHB clock rate for the TSC peripheral as the first and only thing. Instead we have a clock pre-scaler value to divide clock further before it enters the TSC. User manuals tells us the location of this register that controls this.</p>
<details>
<p><summary> TSC CR (TSC Control Register Bits 15 and 14:12) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>15</strong></th>
<th style="text-align: center;"><strong>14:12</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SSPSC</td>
<td style="text-align: center;">PGPSC[2:0]</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Spread spectrum prescaler</td>
<td style="text-align: center;">Pulse generator prescaler</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>0</code>: <code>fHCLK</code><br><code>1</code>: <code>fHCLK /2</code></td>
<td style="text-align: center;"><code>000</code>: <code>fHCLK</code><br>...<br><code>111</code>: <code>fHCLK /128</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</details>
<p>There are two clock settings</p>
<ul>
<li><code>PGPSC</code> (Pulse Generator Prescaler) and it is a 3-bit value, and each represents a different division factor.adjust the clock rate for the TSC peripheral.</li>
<li><code>SSPSC</code> (Spread Spectrum Prescaler) and it is a 1-bit value. <code>0: AHB/1</code> and <code>1: AHB/2</code>.</li>
</ul>
<p>Defining the clock finally gives us the full cycle duration for one charge transfer cycle. In <code>U0</code> series this can be from 500ns to 2us.</p>
<h4 id="tsc-pulse-generator-configuration">TSC Pulse Generator Configuration</h4>
<p>This section is the heart of the peripheral configuration and there are a few settings we can adjust;</p>
<ul>
<li>Charging duration</li>
<li>Transfer Duration</li>
<li>Max Cycle Count</li>
</ul>
<details>
<p><summary> TSC CR (TSC Control Register Bits 31:28, 27:24 and 7:5) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>31:28</strong></th>
<th style="text-align: center;"><strong>27:24</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>7:5</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">CTPH[3:0]</td>
<td style="text-align: center;">CTPL[3:0]</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MCV[2:0]</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Charge transfer pulse high</td>
<td style="text-align: center;">Charge transfer pulse low</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Max count value</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>0000</code>: 1x tPGCLK<br><code>...</code><br><code>1111</code>: 16x tPGCLK</td>
<td style="text-align: center;"><code>0000</code>: 1x tPGCLK<br><code>...</code><br><code>1111</code>: 16x tPGCLK</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>000</code>: 255<br><code>001</code>: 511<br><code>...</code><br><code>110</code>: 16383</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</details>
<p>Charging and transfer durations are denoted as <code>CTPH</code> (Charge Transfer Pulse High) and <code>CTPL</code> (Charge Transfer Pulse Low) respectively. These are 4-bit values and can be adjusted from 1 to 16 clock cycles. These values are used to charge the external capacitor and transfer the charge to the sample capacitor.</p>
<p>Max cycle count is a 3-bit value and each represents a different count value. This is a safety feature where TSC can not fill the capacitor enough to reach the voltage threshold, so it stops the cycle and throws an interrupt.</p>
<h4 id="tsc-spread-spectrum-configuration">TSC Spread Spectrum Configuration</h4>
<details>
<p><summary> TSC CR (TSC Control Register Bits 23:17 and 16) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>23:17</strong></th>
<th style="text-align: center;"><strong>16</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SSD[6:0]</td>
<td style="text-align: center;">SSE</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Spread spectrum deviation</td>
<td style="text-align: center;">Spread spectrum enable</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>0000000</code>: 1x tSSCLK<br><code>...</code><br><code>1111111</code>: 128x tSSCLK</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: Enabled</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</details>
<p>Spread spectrum has 9-bits for configuration in the <code>CR</code> register. The pre-scaler bit is already set, so rest if a 1-bit enable and 7-bit deviation value.The deviation value represents the maximum deviation of the charge transfer pulse in spread spectrum clock cycles.</p>
<h4 id="tsc-sync-configuration">TSC SYNC Configuration</h4>
<p>There are only two bits related to this setting, one is for selecting the polarity and the other is for enabling the SYNC signal.</p>
<details>
<p><summary> TSC CR (TSC Control Register Bits 4 and 3) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>3</strong></th>
<th style="text-align: center;"><strong>2</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SYNCPOL</td>
<td style="text-align: center;">SYNC Enable</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Synchronization pin polarity</td>
<td style="text-align: center;">Synchronization enable</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>0</code>: Falling edge only<br><code>1</code>: Rising edge and high level</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: Enabled</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</details>
<h4 id="tsc-interrupts">TSC Interrupts</h4>
<p>There are only 2 interrupts, <code>EOAF</code> (End of Acquisition Flag) and <code>MCEF</code> (Max Count Error Flag). These are set when the voltage threshold is reached or the max cycle count is reached respectively. They are enabled through a different register called <code>IER</code> (Interrupt Enable Register).</p>
<details>
<p><summary> TSC IER (TSC Interrupt Enable Register Bits 1 and 0) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:2</strong></th>
<th style="text-align: center;"><strong>1</strong></th>
<th style="text-align: center;"><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">MCEIE</td>
<td style="text-align: center;">EOAIE</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Max count error interrupt enable</td>
<td style="text-align: center;">End of acquisition interrupt enable</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: Enabled</td>
<td style="text-align: center;"><code>0</code>: Disabled<br><code>1</code>: Enabled</td>
</tr>
</tbody>
</table>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is also a setting to adjust the voltage threshold for the end of acquisition, but this is done using a different comparator peripheral, for the sake of simplicity we will not use this feature.</p>
</div>
<h4 id="how-to-read-the-count-value">How to Read the Count Value</h4>
<p>Before we start reading the <code>START</code> bit in the <code>CR</code> register should be set to start the acquisition. After the acquisition is done, the peripheral will throw an interrupt or we can poll the <code>EOAF</code> bit in the <code>ISR</code> register to check if the acquisition is done. Then we can read the status of each group with <code>IOGSR</code> and see if that group has finished the acquisition. If it has we can read the count value from the <code>IOGXCR</code> register.</p>
<details>
<p><summary> TSC CR (TSC Control Register Bits 0) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:1</strong></th>
<th style="text-align: center;"><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">START</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Start acquisition</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: No effect<br><code>1</code>: Start acquisition</td>
</tr>
</tbody>
</table>
</details>
<details>
<p><summary> TSC ISR (TSC Interrupt Status Register Bits 1 and 0) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:2</strong></th>
<th style="text-align: center;"><strong>1</strong></th>
<th style="text-align: center;"><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">MCEF</td>
<td style="text-align: center;">EOAF</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Max count error flag</td>
<td style="text-align: center;">End of acquisition flag</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: No error<br><code>1</code>: Error</td>
<td style="text-align: center;"><code>0</code>: No end of acquisition<br><code>1</code>: End of acquisition</td>
</tr>
</tbody>
</table>
</details>
<details>
<p><summary> TSC IOGCSR (TSC IO Group Control Status Register) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>31:23</strong></th>
<th style="text-align: center;"><strong>22:16</strong></th>
<th style="text-align: center;"><strong>15:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">GxS</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Analog I/O group x status</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Values</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;"><code>0</code>: Ongoing<br><code>1</code>: Complete</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
</details>
<details>
<p><summary> TSC IOGXCR (TSC IO Group X Counter Register) </summary></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Bit</strong></th>
<th style="text-align: center;"><strong>31:14</strong></th>
<th style="text-align: center;"><strong>13:0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>Name</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">CT[13:0]</td>
</tr>
<tr>
<td style="text-align: center;"><strong>Desc.</strong></td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">Counter value</td>
</tr>
</tbody>
</table>
</details>
<p>There are some other minor settings which I will not go into detail because it does not concern the driver implementation. But here is the complete map of the TSC peripheral registers.</p>
<details>
<p><summary> STM32U0 TSC Peripheral Registers </summary></p>
<p><img alt="STM32U0 TSC Registers" src="doc-assets/tsc-registers.png" /></p>
</details>
<h3 id="hardware-configuration">Hardware Configuration</h3>
<p><img alt="STM32 TSC SCH" src="doc-assets/tsc-sch.png" /></p>
<p>The <a href="https://www.st.com/resource/en/schematic_pack/mb1933-u083c-c02-schematic.pdf">development kit schematic</a> shows the implementation is for one electrode (<code>TKEY</code>) and one sampling capacitor (<code>TKEY_CS</code>), so we will stick with that.</p>
<p>Notice how they actually used an extra group for another electrode and called it <code>shield</code> and connected to the end of the electrode to the ground. This is a trick often used to further reduce EMI and noise. Only difference this has over an electrode is this is not selected for acqusition. This is not related to the driver implementation so I will not go into detail.</p>
<p>The pins and their alternate functions are as follows:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>GPIO Pin</strong></th>
<th style="text-align: center;"><strong>GPIO Alternate Function</strong></th>
<th style="text-align: center;"><strong>TSC Group</strong></th>
<th style="text-align: center;"><strong>TSC IO Number</strong></th>
<th style="text-align: center;"><strong>Function</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">PD10</td>
<td style="text-align: center;">AF9</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">TKey CS</td>
</tr>
<tr>
<td style="text-align: center;">PD11</td>
<td style="text-align: center;">AF9</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">TKey</td>
</tr>
<tr>
<td style="text-align: center;">PB12</td>
<td style="text-align: center;">AF9</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Shield Electrode</td>
</tr>
<tr>
<td style="text-align: center;">PB13</td>
<td style="text-align: center;">AF9</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Shield Electrode Sampling Capacitor</td>
</tr>
</tbody>
</table>
<p>I talk more about this in the next section, but this is the hardware we will work with.</p>
<h3 id="device-tree-nodes-and-bindings">Device Tree Nodes and Bindings</h3>
<p>One of the first things to do is to create a device tree binding to describe our hardware before the implementation starts. The concept of device trees are not new and is used in Linux for many years, so it may be familiar to some of you, but for those who are unfamiliar, it is a JSON-like file that describes a hardware node in a system called <code>device-tree</code>, this allows for decoupling the hardware from the source code so that software may run independent of the hardware it is running on, meaning the API won't change if you change the hardware.</p>
<p>To know more about device trees check out the <a href="https://www.devicetree.org/">official documentation</a>.</p>
<p>To sketch a design lets thinker about a node for the hardware above. This is an attempt to create a definition that will contain all hardware related information in a single node for this peripheral.</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nl">tsc</span> <span class="p">:</span><span class="w"> </span><span class="nf">tsc</span><span class="o">@</span><span class="mi">40024000</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-tsc&quot;</span><span class="p">;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40024000</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x01000000</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="n">resets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rctl</span><span class="w"> </span><span class="na">STM32_RESET</span><span class="p">(</span><span class="na">AHB1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="na">U</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">21</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>This simple node seems pretty self-explanatory, it has the most generic properties common to almost all ST -or ARM really- compatible peripherals, a register space, clock, reset and interrupt. The node describes a TSC node with the label <code>tsc</code> and at the address <code>0x40024000</code> which corresponds to the beginning of address space of the TSC module in <code>STM32U0x</code> series microcontrollers, this is the most fundamental information we should have about a memory-mapped io. We can see this information is encoded twice (both in definition with <code>@</code> symbol and with <code>reg</code> property). We can also see the entire memory mapped region is 1KB (<code>0x400</code>), it's clock is connected to the <code>AHB1</code> (24th bit <code>0x01000000</code> of the AHB control register), also it has a reset line again at the bit position 24 in the corresponding reset controller control register (created with <code>STM32_RESET</code> macro). In the vector table the position offset of its interrupt is <code>21</code> and has <code>0</code> priority. Another very important property is the <code>compatible</code> property, this is a string that describes the driver that will handle this node, in other words, this node information will be passed to a driver that declares itself as <code>st,stm32-tsc</code> compatible. Very neat!</p>
<p>A <code>node binding</code> is any property of a node, described in a file, a <code>yaml</code> file in our case, so to make our <code>st,stm32-tsc</code> node work we need to create a binding file for it, so that we can enforce out properties and rules about those properties. And there are strict rules to follow about the location of these files and the naming conventions. The binding files must be in the <code>dts/bindings</code> directory of workspace or application root, board directories or in modules. We will create our own in the workspace root.</p>
<p>The naming convention for the binding files are usually <code>vendor,driver.yaml</code> (<code>vendor</code> is optional for generic drivers) and usually they reside in subfolders for better organization. So we will create ours in <code>misc</code> folder and put the binding there.</p>
<p>And create the <code>st,stm32-tsc.yaml</code> file with the following content:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># zephyr/dts/bindings/misc/st,stm32-tsc.yaml</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STM32 Tocuh Sensing Controller (TSC) driver</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="nt">compatible</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;st,stm32-tsc&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">base.yaml</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">reset-device.yaml</span><span class="p p-Indicator">]</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span><span class="nt">reg</span><span class="p">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="nt">clocks</span><span class="p">:</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">  </span><span class="nt">resets</span><span class="p">:</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">  </span><span class="nt">interrupts</span><span class="p">:</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>as you can tell from the file, all the properties are included from other files Zephyr provides for us, this file only makes some of them required. Their definition can be seen in one of these included files; <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/dts/bindings/base/base.yaml"><code>base.yaml</code></a></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># zephyr/dts/bindings/base/base.yaml</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">compatible</span><span class="p">:</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string-array</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compatible strings</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="nt">reg</span><span class="p">:</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">register space</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="nt">interrupts</span><span class="p">:</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">interrupts for device</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div>
<p>This binding file will make sure we have the properties we need, and they are parsed correctly for the relevant hardware node with the matching <code>compatible</code> property.</p>
<p>Again these documents are quite verbose and easy to read and maintain, so that's good. They can also get pretty messy if you don't do it right, so please follow the <a href="https://docs.zephyrproject.org/latest/guides/dts/bindings.html">official documentation</a> for more information.</p>
<p>Of course up to this point we only included and set up bindings for the information to enable the peripheral (<code>reg</code>, <code>clocks</code>, <code>resets</code> and <code>interrupts</code>), but we also have to configure it, which requires additional bindings. We went into detail in the section <a href="#understanding-the-hardware">Understanding the Hardware</a> so I will not go into detail here, but basically we will need the following information to set up a TSC peripheral:</p>
<ul>
<li>IO pins for the electrodes and sampling capacitors</li>
<li>Pulse generator prescaler value</li>
<li>Spread spectrum prescaler, deviation and enable</li>
<li>Charge transfer pulse high and low values</li>
<li>Max count value</li>
<li>SYNC signal polarity and enable</li>
</ul>
<h4 id="pin-control">Pin Control</h4>
<p>We discussed how configuring the physical pins is a job of another peripheral, <code>pintcrl-device.yaml</code> provides some bindings to allow generic nodes to provide pin configuration information. It is called <code>pinctrl-X</code> where <code>X</code> is the number of the pin group. Take a look at the property;</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># zephyr/dts/bindings/pinctrl-device.yaml</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nt">pinctrl-0</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">phandles</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">      </span><span class="no">Pin configuration/s for the first state. Content is specific to the</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">      </span><span class="no">selected pin controller driver implementation.</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="nn">...</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="nt">pinctrl-x</span><span class="p">:</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">phandles</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">      </span><span class="no">Pin configuration/s for the x-th state. Content is specific to the</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">      </span><span class="no">selected pin controller driver implementation.</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="nt">pinctrl-names</span><span class="p">:</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string-array</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">      </span><span class="no">Names for the provided states. The number of names needs to match the</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">      </span><span class="no">number of states.</span>
</span></code></pre></div>
<p>A pin configuration can change based on whether the device is running or in sleep mode to preserve power. So we can have multiple states for the pin configuration, separated by the <code>pinctrl-names</code> property. It usually is <code>default</code> and <code>sleep</code> but can be anything. The <code>phandles</code> property is just a reference to another node, so we can point to other nodes which will include the pin information, defined somewhere else.</p>
<p>To have this binding required in our <code>st,stm32-tsc.yaml</code> file we just need to add the following lines:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">pinctrl-0</span><span class="p p-Indicator">:</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">  </span><span class="nt">pinctrl-names</span><span class="p">:</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>The use of this binding in the driver implementation will be discussed in the next sections. But the following snippet can give you a glimpse of how it can be used in a device tree node.;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="o">&amp;</span><span class="na">node</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">pin_d12_af9</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="p">};</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="o">&amp;</span><span class="na">pinctrl</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="nl">pin_d12_af9</span><span class="p">:</span><span class="w"> </span><span class="nf">pinconfig1</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="p">};</span>
</span></code></pre></div>
<p>The <code>&amp;</code> symbol works very similar to a pointer in C, in this example we are referencing already existing nodes (through labels; <code>node-label: node-name</code>) and altering them (<code>node</code> and <code>pinctrl</code>) in the device tree. <code>STM32_PINMUX</code> is just a C macro and literally coming from an included header file. We can supply the pin, its function and additional properties like <code>push-pull</code> or <code>open-drain</code>. And passing the definition of these <code>pinctrl</code> nodes to the <code>node</code> node will make sure the pins are configured correctly when the driver is loaded.</p>
<p>So based on this let's define the pins and their functions for this development kit. <a href="#hardware-configuration">Schematic tells us</a> there is two pins used in this board, one is a shield electrode and the other is the touch electrode itself, of course each with their own sampling capacitor pins. 4 in total. These pins are also belong to a group, ST choose group 1 and group 6 for these pins and they nicely provide a table for the pins in the <a href="https://www.st.com/resource/en/user_manual/um3292-discovery-kit-with-stm32u083mc-mcu-stmicroelectronics.pdf">UM3292</a> user manual. I also talked about them in the <a href="#hardware-configuration">Hardware Configuration</a> section.</p>
<p>Also In the reference manual we can get the information about which alternate function is used for the TSC group configuration for that specific pin, conveniently all of them are <code>AF9</code> for these pins. So we can define them in the device tree as follows;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="o">&amp;</span><span class="na">pinctrl</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="nl">tsc_shield_pb12</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_pb12</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="nl">tsc_shield_cs_pb13</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_cs_pb13</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span><span class="nl">tsc_g6_io1_pd10</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io1_pd10</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey CS pin</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">  </span><span class="nl">tsc_g6_io2_pd11</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io2_pd11</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey Pin</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="p">};</span>
</span></code></pre></div>
<p>And later we will provide these pins to the TSC node in the device tree;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="o">&amp;</span><span class="na">tsc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tsc_shield_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_cs_pb13</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io1_pd10</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io2_pd11</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>and use this information to set up the GPIO pins in the driver implementation.</p>
<p>It is important to define these pins inside the <code>pinctrl</code> parent node so we can use the bindings like <code>drive-open-drain</code> and <code>pinmux</code> in the child nodes. This node is provided by your vendor in the <code>soc</code> device tree file, this file and many other will be included in the final device tree file, so many overlays can be used to configure the hardware, SOC DTS files &gt; Board DTS files &gt; Application DTS files &gt; Final DTS file.</p>
<h4 id="other-bindings">Other Bindings</h4>
<p>Now we only deal with bindings with basic types, like <code>int</code>, <code>enum</code>, <code>string</code> and <code>boolean</code>.</p>
<h5 id="pulse-generator-prescaler">Pulse Generator Prescaler</h5>
<p>The pulse generator prescaler is a 3-bit value as discussed in the <a href="#tsc-pulse-generator-configuration">Registers and Configurations</a> section, so it can be defined as an enum in the binding file.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">pulse-generator-prescaler</span><span class="p">:</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">      </span><span class="no">Prescaler for the pulse generator clock (t_pgclk=f_hclk/prescaler).</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">      </span><span class="no">The prescaler is used to generate the charge transfer pulse.</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">      </span><span class="no">0: f_hclk/1</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">      </span><span class="no">1: f_hclk/2</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">      </span><span class="no">2: f_hclk/4</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">      </span><span class="no">3: f_hclk/8</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">      </span><span class="no">4: f_hclk/16</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">      </span><span class="no">5: f_hclk/32</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">      </span><span class="no">6: f_hclk/64</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">      </span><span class="no">7: f_hclk/128</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">    </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<h5 id="charge-transfer-pulse-high-and-low">Charge Transfer Pulse High and Low</h5>
<p>These are 4-bit values, this too can be defined as integer enum.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="w">  </span><span class="nt">ctph</span><span class="p">:</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">      </span><span class="no">Number of cycles for the high state of the </span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">      </span><span class="no">charge transfer pulse (1 to 16 cycles of t_pgclk).</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">11</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">13</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">14</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">15</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">16</span><span class="p p-Indicator">]</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">  </span><span class="nt">ctpl</span><span class="p">:</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">      </span><span class="no">Number of cycles for the low state of the </span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">      </span><span class="no">charge transfer pulse (1 to 16 cycles of t_pgclk).</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">11</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">13</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">14</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">15</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">16</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<h5 id="max-count-value">Max Count Value</h5>
<p>This is a 3-bit value, we can define it as an integer enum.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">max-count-value</span><span class="p">:</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">      </span><span class="no">Max number of charge transfer pulses before max count error is generated.</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">      </span><span class="no">0: 255</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">      </span><span class="no">1: 511</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">      </span><span class="no">2: 1023</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">      </span><span class="no">3: 2047</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">      </span><span class="no">4: 4095</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">      </span><span class="no">5: 8191</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">      </span><span class="no">6: 16383</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">      </span><span class="no">7: 32767</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<h5 id="spread-spectrum">Spread Spectrum</h5>
<p>The spread spectrum prescaler is a 1-bit value, it should be easy to define.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nt">spread-spectrum-prescaler</span><span class="p">:</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Spread spectrum clock prescaler (t_ssclk)</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="nt">enum</span><span class="p">:</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span></code></pre></div>
<p>and to enable it we can define a boolean property.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="w">  </span><span class="nt">spread-spectrum</span><span class="p">:</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Spread spectrum enable</span>
</span></code></pre></div>
<p>These boolean properties are easy to use;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="o">&amp;</span><span class="na">tsc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="n">spread-spectrum</span><span class="p">;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="n">spread-spectrum-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>We also need to define the deviation value for the spread spectrum, it can have a value from 0 to 127. But for convenience we will start from 1 and offset it in the driver implementation.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nt">spread-spectrum-deviation</span><span class="p">:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Spread spectrum deviation (1 to 128 cycles of t_ssclk)</span>
</span></code></pre></div>
<h5 id="sync-signal">SYNC Signal</h5>
<p>We have two properties for the SYNC signal, one is for the polarity and the other is for the enable.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nt">synced-acquisition</span><span class="p">:</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">      </span><span class="no">Synchronized acquisition enable. Acquisition starts when START bit and signal on sync pin.</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">      </span><span class="no">You have to provide a pinctrl for the sync pin.</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w w-Error">  </span><span class="nt">syncpol-rising</span><span class="p">:</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rising synchronization pin polarity, instead of falling</span>
</span></code></pre></div>
<p>I choose to use a boolean property for the polarity it could also be a string enum, but I think this is more readable.</p>
<h5 id="io-default-mode">IO Default Mode</h5>
<p>IO mode is 1-bit value, it can be either floating or driven low (default).</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="w">  </span><span class="nt">iodef-float</span><span class="p">:</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">      </span><span class="no">I/Os are floating when not used for acquisition.</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">      </span><span class="no">If not set, I/Os are driven low.</span>
</span></code></pre></div>
<h4 id="child-nodes-and-bindings">Child Nodes and Bindings</h4>
<p>We talked about the group logic in the <a href="#understanding-the-hardware">Understanding the Hardware</a> section. Once we enable the TSC peripheral, we should also enable groups and channels within those groups for acquisition. Device tree offers a way to describe these as child nodes of the TSC node. Lets say we can define a group node as follows;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="o">&amp;</span><span class="na">tsc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="na">group1</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="n">use-as-shield</span><span class="p">;</span><span class="o">****</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">  </span><span class="nf">group6</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="p">};</span>
</span></code></pre></div>
<p>So this nodes inside the <code>tsc</code> node are called child nodes, and in our case they give us information about the group index, channel and sampling io pin bits and one more property to use the group as shield (basically configure the group but do not acquire a value from it). We can define these nodes in the binding file as follows;</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># zephyr/dts/bindings/misc/st,stm32-tsc.yaml</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nt">child-binding</span><span class="p">:</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STM32 TSC group configuration</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">  </span><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="nt">group</span><span class="p">:</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">      </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group number (0 to 7)</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">      </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">]</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="nt">channel-ios</span><span class="p">:</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Channel I/Os to be enabled</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">      </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">11</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">13</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">14</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">15</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">16</span><span class="p p-Indicator">]</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">    </span><span class="nt">sampling-io</span><span class="p">:</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">      </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Channel to be selected for sampling</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">      </span><span class="nt">enum</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">]</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">    </span><span class="nt">use-as-shield</span><span class="p">:</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">        </span><span class="no">Use channel as shield. This configures group but </span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">        </span><span class="no">does not enable it for acqusition. channel-io is used </span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">        </span><span class="no">as shield pin and can only have values 1, 2, 4 or 8.</span>
</span></code></pre></div>
<p>This information unfortunately can not be extracted from the pin information, so child nodes like these are required to configure and acquire data from the TSC peripheral.</p>
<h4 id="final-binding-file-and-device-tree-nodes">Final Binding File and Device Tree Nodes</h4>
<p>For the device tree, we will have two definitions in two different files. The first definition is the core information about the peripheral, and is the same for all <code>U0</code> series microcontrollers. Therefore it has to be inside the main <code>stm32u0.dtsi</code> file which all stm32u0 based boards include (device tree files can be nested and included in each other).</p>
<p>This file already exists in upstream Zephyr, under <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/dts/arm/st/u0/stm32u0.dtsi"><code>dts/arm/st/u0/stm32u0.dtsi</code></a>, we just need to modify it.</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="o">#</span><span class="w"> </span><span class="na">zephyr</span><span class="o">/</span><span class="na">dts</span><span class="o">/</span><span class="na">arm</span><span class="o">/</span><span class="na">st</span><span class="o">/</span><span class="na">u0</span><span class="o">/</span><span class="na">stm32u0</span><span class="p">.</span><span class="na">dtsi</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="na">soc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="nl">tsc</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc</span><span class="o">@</span><span class="mi">40024000</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-tsc&quot;</span><span class="p">;</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40024000</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x01000000</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="n">resets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rctl</span><span class="w"> </span><span class="na">STM32_RESET</span><span class="p">(</span><span class="na">AHB1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="na">U</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">21</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="n">interrupt-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;global&quot;</span><span class="p">;</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;disabled&quot;</span><span class="p">;</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="p">};</span>
</span></code></pre></div>
<p>We define the node and let it be disabled by default so our driver wont be compiled into the application until <code>status</code> is set to <code>okay</code>.</p>
<p>The second definition is in the development kit specific file, <code>stm32u083c-dk.dts</code> in our case, this file again is defined in the upstream Zephyr, under <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/boards/st/stm32u083c_dk/stm32u083c_dk.dts"><code>boards/st/stm32u083c_dk/stm32u083c_dk.dts</code></a>. This file will contain the information about the pins and the groups we will use in the TSC peripheral along with the pin configuration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also define these in the <a href="https://docs.zephyrproject.org/latest/build/dts/howtos.html#use-devicetree-overlays">device tree overlay file</a> in your application, and avoid modifying files inside Zephyr source, but since we already have a demo board definition we will use that.</p>
<p><details markdown="1"> <summary> If you want to use an overlay it would look something like this; </summary></p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="na">include</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="o">&amp;</span><span class="na">soc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nl">tsc</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc</span><span class="o">@</span><span class="mi">40024000</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x01000000</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="n">resets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rctl</span><span class="w"> </span><span class="na">STM32_RESET</span><span class="p">(</span><span class="na">AHB1</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="na">U</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">21</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">    </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tsc_shield_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_cs_pb13</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io1_pd10</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io2_pd11</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="n">spread-spectrum</span><span class="p">;</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">    </span><span class="n">spread-spectrum-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">    </span><span class="n">spread-spectrum-deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="nf">g1</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">      </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">      </span><span class="n">use-as-shield</span><span class="p">;</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">      </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">      </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">    </span><span class="nf">g6</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">      </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">      </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">      </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="p">};</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="o">&amp;</span><span class="nf">pinctrl</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">   </span><span class="nl">tsc_shield_pb12</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_pb12</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">   </span><span class="nl">tsc_shield_cs_pb13</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_cs_pb13</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="w">   </span><span class="nl">tsc_g6_io1_pd10</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io1_pd10</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey CS pin</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">   </span><span class="nl">tsc_g6_io2_pd11</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io2_pd11</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey Pin</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="p">};</span>
</span></code></pre></div>
</details>
</div>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="o">#</span><span class="w"> </span><span class="na">zephyr</span><span class="o">/</span><span class="na">boards</span><span class="o">/</span><span class="na">st</span><span class="o">/</span><span class="na">stm32u083c_dk</span><span class="o">/</span><span class="na">stm32u083c_dk</span><span class="p">.</span><span class="na">dts</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="o">#</span><span class="na">include</span><span class="w"> </span><span class="o">&lt;</span><span class="na">zephyr</span><span class="o">/</span><span class="na">dt</span><span class="o">-</span><span class="na">bindings</span><span class="o">/</span><span class="na">misc</span><span class="o">/</span><span class="na">stm32</span><span class="o">-</span><span class="na">tsc</span><span class="o">-</span><span class="na">defines</span><span class="p">.</span><span class="na">h</span><span class="o">&gt;</span><span class="w"> </span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="o">&amp;</span><span class="na">tsc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">  </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;disabled&quot;</span><span class="p">;</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">  </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tsc_shield_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_cs_pb13</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io1_pd10</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io2_pd11</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">  </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">  </span><span class="n">spread-spectrum</span><span class="p">;</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">  </span><span class="n">spread-spectrum-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">  </span><span class="n">spread-spectrum-deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">  </span><span class="nf">g1</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span><span class="n">use-as-shield</span><span class="p">;</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">  </span><span class="nf">g6</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">    </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">    </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="p">};</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="o">&amp;</span><span class="nf">pinctrl</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">   </span><span class="nl">tsc_shield_pb12</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_pb12</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">   </span><span class="nl">tsc_shield_cs_pb13</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_cs_pb13</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">   </span><span class="nl">tsc_g6_io1_pd10</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io1_pd10</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey CS pin</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="w">   </span><span class="nl">tsc_g6_io2_pd11</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io2_pd11</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// TKey Pin</span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="p">};</span>
</span></code></pre></div>
<p>The peripheral and the groups are defined as child nodes of the TSC node. Pins are supplied and spread spectrum feature is enabled and configured. The <code>status</code> property is set to <code>disabled</code> by default, users will be able to enable this in application overlay file.</p>
<p>Notice how this information could only be given in the development kit specific file instead of the soc definition, because the pins are different in every board. And other bindings are also application specific.</p>
<p>When device tree compiler compiles all the device tree files into one final device tree, we get the following node;</p>
<div class="language-dts highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nf">/</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">  </span><span class="nf">soc</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="nf">pinctrl</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">      </span><span class="p">...</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">      </span><span class="nl">tsc_shield_pb12</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_pb12</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">        </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x789</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">        </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">        </span><span class="kr">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">      </span><span class="nl">tsc_shield_cs_pb13</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_shield_cs_pb13</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">        </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x7a9</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">        </span><span class="kr">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x11</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">      </span><span class="nl">tsc_g6_io1_pd10</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io1_pd10</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">        </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x749</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">        </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">        </span><span class="kr">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x12</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">      </span><span class="nl">tsc_g6_io2_pd11</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc_g6_io2_pd11</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">        </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x769</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="kr">phandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x13</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">    </span><span class="nl">tsc</span><span class="p">:</span><span class="w"> </span><span class="nf">tsc</span><span class="o">@</span><span class="mi">40024000</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">      </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-tsc&quot;</span><span class="p">;</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">      </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x40024000</span><span class="w"> </span><span class="mh">0x400</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">      </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="mh">0x48</span><span class="w"> </span><span class="mh">0x1000000</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">      </span><span class="n">resets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">&amp;</span><span class="na">rctl</span><span class="w"> </span><span class="mh">0x518</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">      </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x15</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">      </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;disabled&quot;</span><span class="p">;</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">      </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_cs_pb13</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io1_pd10</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io2_pd11</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">      </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">      </span><span class="n">spread-spectrum</span><span class="p">;</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">      </span><span class="n">spread-spectrum-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x2</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="w">      </span><span class="n">spread-spectrum-deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x64</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="w">      </span><span class="nf">g1</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">        </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a><span class="w">        </span><span class="n">use-as-shield</span><span class="p">;</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">        </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x2</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="w">        </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="w">      </span><span class="nf">g6</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a><span class="w">        </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x6</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a><span class="w">        </span><span class="n">channel-ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x2</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a><span class="w">        </span><span class="n">sampling-io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a><span class="p">}</span>
</span></code></pre></div>
<p>All files included and all macros expanded, this is the final device tree node that will be converted to a header file (instead of a binary blob used in Linux) containing all this information as C defines, so they will take up no space if not used. This generated header file can not be used directly as it is pretty verbose and hard to read;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">// devicetree_generated.h</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="p">...</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="cm">/*</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="cm"> * Devicetree node: /soc/tsc@40024000</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="cm"> *</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="cm"> * Node identifier: DT_N_S_soc_S_tsc_40024000</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="cm"> *</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="cm"> * Binding (compatible = st,stm32-tsc):</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="cm"> *   /workdir/zephyr/dts/bindings/misc/st,stm32-tsc.yaml</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="cm"> *</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="cm"> * (Descriptions have moved to the Devicetree Bindings Index</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="cm"> * in the documentation.)</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="cm"> */</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="cm">/* Node&#39;s full path: */</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_PATH &quot;/soc/tsc@40024000&quot;</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="cm">/* Node&#39;s name with unit-address: */</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_FULL_NAME &quot;tsc@40024000&quot;</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="cm">/* Node parent (/soc) identifier: */</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_PARENT DT_N_S_soc</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="cm">/* Macros for properties that are special in the specification: */</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_REG_NUM 1</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_REG_IDX_0_EXISTS 1</span>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_REG_IDX_0_VAL_ADDRESS 1073889280 </span><span class="cm">/* 0x40024000 */</span>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_REG_IDX_0_VAL_SIZE 1024 </span><span class="cm">/* 0x400 */</span>
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_RANGES_NUM 0</span>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_FOREACH_RANGE(fn) </span>
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NUM 1</span>
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_EXISTS 1</span>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_irq 21</span>
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_irq_EXISTS 1</span>
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_EXISTS 1</span>
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_priority 0</span>
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_priority_EXISTS 1</span>
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_CONTROLLER DT_N_S_soc_S_interrupt_controller_e000e100</span>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_LEVEL 1</span>
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NAME_global_VAL_irq DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_irq</span>
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NAME_global_VAL_irq_EXISTS 1</span>
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NAME_global_VAL_priority DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_VAL_priority</span>
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NAME_global_VAL_priority_EXISTS 1</span>
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_IRQ_NAME_global_CONTROLLER DT_N_S_soc_S_tsc_40024000_IRQ_IDX_0_CONTROLLER</span>
</span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_COMPAT_MATCHES_st_stm32_tsc 1</span>
</span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_COMPAT_VENDOR_IDX_0_EXISTS 1</span>
</span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_COMPAT_VENDOR_IDX_0 &quot;STMicroelectronics&quot;</span>
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_COMPAT_MODEL_IDX_0_EXISTS 1</span>
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_COMPAT_MODEL_IDX_0 &quot;stm32-tsc&quot;</span>
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_STATUS_okay 1</span>
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_resets_LEN 1</span>
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_resets_EXISTS 1</span>
</span><span id="__span-29-55"><a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_pulse_generator_prescaler 2</span>
</span><span id="__span-29-56"><a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_pulse_generator_prescaler_ENUM_IDX 2</span>
</span><span id="__span-29-57"><a id="__codelineno-29-57" name="__codelineno-29-57" href="#__codelineno-29-57"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_pulse_generator_prescaler_ENUM_VAL_2_EXISTS 1</span>
</span><span id="__span-29-58"><a id="__codelineno-29-58" name="__codelineno-29-58" href="#__codelineno-29-58"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_pulse_generator_prescaler_EXISTS 1</span>
</span><span id="__span-29-59"><a id="__codelineno-29-59" name="__codelineno-29-59" href="#__codelineno-29-59"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctph 2</span>
</span><span id="__span-29-60"><a id="__codelineno-29-60" name="__codelineno-29-60" href="#__codelineno-29-60"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctph_ENUM_IDX 1</span>
</span><span id="__span-29-61"><a id="__codelineno-29-61" name="__codelineno-29-61" href="#__codelineno-29-61"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctph_ENUM_VAL_2_EXISTS 1</span>
</span><span id="__span-29-62"><a id="__codelineno-29-62" name="__codelineno-29-62" href="#__codelineno-29-62"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctph_EXISTS 1</span>
</span><span id="__span-29-63"><a id="__codelineno-29-63" name="__codelineno-29-63" href="#__codelineno-29-63"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctpl 2</span>
</span><span id="__span-29-64"><a id="__codelineno-29-64" name="__codelineno-29-64" href="#__codelineno-29-64"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctpl_ENUM_IDX 1</span>
</span><span id="__span-29-65"><a id="__codelineno-29-65" name="__codelineno-29-65" href="#__codelineno-29-65"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctpl_ENUM_VAL_2_EXISTS 1</span>
</span><span id="__span-29-66"><a id="__codelineno-29-66" name="__codelineno-29-66" href="#__codelineno-29-66"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_ctpl_EXISTS 1</span>
</span><span id="__span-29-67"><a id="__codelineno-29-67" name="__codelineno-29-67" href="#__codelineno-29-67"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_spread_spectrum 0</span>
</span><span id="__span-29-68"><a id="__codelineno-29-68" name="__codelineno-29-68" href="#__codelineno-29-68"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_spread_spectrum_EXISTS 1</span>
</span><span id="__span-29-69"><a id="__codelineno-29-69" name="__codelineno-29-69" href="#__codelineno-29-69"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_spread_spectrum_deviation 1</span>
</span><span id="__span-29-70"><a id="__codelineno-29-70" name="__codelineno-29-70" href="#__codelineno-29-70"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_spread_spectrum_deviation_EXISTS 1</span>
</span><span id="__span-29-71"><a id="__codelineno-29-71" name="__codelineno-29-71" href="#__codelineno-29-71"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_max_count_value 5</span>
</span><span id="__span-29-72"><a id="__codelineno-29-72" name="__codelineno-29-72" href="#__codelineno-29-72"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_max_count_value_ENUM_IDX 5</span>
</span><span id="__span-29-73"><a id="__codelineno-29-73" name="__codelineno-29-73" href="#__codelineno-29-73"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_max_count_value_ENUM_VAL_5_EXISTS 1</span>
</span><span id="__span-29-74"><a id="__codelineno-29-74" name="__codelineno-29-74" href="#__codelineno-29-74"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_max_count_value_EXISTS 1</span>
</span><span id="__span-29-75"><a id="__codelineno-29-75" name="__codelineno-29-75" href="#__codelineno-29-75"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_iodef_float 0</span>
</span><span id="__span-29-76"><a id="__codelineno-29-76" name="__codelineno-29-76" href="#__codelineno-29-76"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_iodef_float_EXISTS 1</span>
</span><span id="__span-29-77"><a id="__codelineno-29-77" name="__codelineno-29-77" href="#__codelineno-29-77"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_synced_acquisition 0</span>
</span><span id="__span-29-78"><a id="__codelineno-29-78" name="__codelineno-29-78" href="#__codelineno-29-78"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_synced_acquisition_EXISTS 1</span>
</span><span id="__span-29-79"><a id="__codelineno-29-79" name="__codelineno-29-79" href="#__codelineno-29-79"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_syncpol_rising 0</span>
</span><span id="__span-29-80"><a id="__codelineno-29-80" name="__codelineno-29-80" href="#__codelineno-29-80"></a><span class="cp">#define DT_N_S_soc_S_tsc_40024000_P_syncpol_rising_EXISTS 1</span>
</span><span id="__span-29-81"><a id="__codelineno-29-81" name="__codelineno-29-81" href="#__codelineno-29-81"></a>
</span><span id="__span-29-82"><a id="__codelineno-29-82" name="__codelineno-29-82" href="#__codelineno-29-82"></a><span class="p">...</span>
</span></code></pre></div>
<p>The values are not meant to be accessed directly by us, instead <a href="https://docs.zephyrproject.org/latest/build/dts/api-usage.html">a macro library</a> is used to get the values programmatically. In my opinion this part needs a rework because it is very hard to trace macros when something is not right and you want to debug, but I think Zephyr is already working on a revised solution.</p>
<p>An example of how to access these values can be seen below;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="n">DT_PROP</span><span class="p">(</span><span class="n">DT_NODELABEL</span><span class="p">(</span><span class="n">tsc</span><span class="p">),</span><span class="w"> </span><span class="n">pulse_generator_prescaler</span><span class="p">);</span><span class="w"> </span><span class="c1">// 2</span>
</span></code></pre></div>
<h3 id="plumbing-device-tree-to-driver-code">Plumbing Device Tree to Driver Code</h3>
<p>We have a binding file that defines the information the driver would need to work with a general STM32 TSC peripheral, and we have a device tree node that describes a specific instance of this peripheral. Now we need to write a driver that will use this information to configure and use the peripheral. From now on the idea is that this hardware node can be inside any ARM Cortex-M based STM32 microcontroller, and we will be able to use the same driver for all of them. Also our code wont only run on a specific hardware node, but instead may work on any hardware node that has the same properties (same <code>compatible</code> property in the device tree), so multiple TSC hardware can be used in the same application even though ST has no MCU with such feature, it's best practice to write drivers this way in case ST releases a new MCU with multiple TSC peripherals.</p>
<p>We therefore need to store all these information in a struct inside our MCU, preferably in flash memory so it won't take up any RAM.</p>
<h4 id="device-tree-macros">Device Tree Macros</h4>
<p>Zephyr provides us with a set of macros to access the device tree properties in the generated header file. These are usually harder to debug when something goes wrong but it makes everything compile-time. To use it we need to include the API from <code>zephyr/include/zephyr/devicetree.h</code>.;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span></code></pre></div>
<h4 id="register-base-address">Register Base Address</h4>
<p>The memory address is the first thing we care about. it will be a 32-bit pointer to the base address of the TSC peripheral and can be casted to a pointer to a struct that represents the TSC peripheral memory layout.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cp">#define TSC_BASE(node) ((TSC_TypeDef *)DT_INST_REG_ADDR(node))</span>
</span></code></pre></div>
<p>So <code>TSC_BASE</code> macro takes a node and calls Zephyr macro <code>DT_INST_REG_ADDR</code> to get the <code>reg</code> property of the node, which is the base address of the peripheral. This is a pointer to the memory mapped registers of the peripheral, we than cast it to a pointer to a struct that represents the TSC peripheral memory layout and we have the peripheral ready to use.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since we are using a multi-instance compatible driver, we use instances, therefore we use the macro <code>DT_INST_REG_ADDR</code> instead of <code>DT_REG_ADDR</code> which is used for single instance drivers. when using <code>_INST</code> macros we need to provide <code>DT_DRV_COMPAT</code> in the beggining of the driver source file later when we create the driver.</p>
</div>
<p><code>TSC_TypeDef</code> is provided by ST and is defined as a simple struct;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">CR</span><span class="p">;</span><span class="w">            </span><span class="cm">/*!&lt; TSC control register,                                     Address offset: 0x00 */</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IER</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; TSC interrupt enable register,                            Address offset: 0x04 */</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ICR</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; TSC interrupt clear register,                             Address offset: 0x08 */</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ISR</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; TSC interrupt status register,                            Address offset: 0x0C */</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOHCR</span><span class="p">;</span><span class="w">         </span><span class="cm">/*!&lt; TSC I/O hysteresis control register,                      Address offset: 0x10 */</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">RESERVED1</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; Reserved,                                                 Address offset: 0x14 */</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOASCR</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; TSC I/O analog switch control register,                   Address offset: 0x18 */</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">RESERVED2</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; Reserved,                                                 Address offset: 0x1C */</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOSCR</span><span class="p">;</span><span class="w">         </span><span class="cm">/*!&lt; TSC I/O sampling control register,                        Address offset: 0x20 */</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">RESERVED3</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; Reserved,                                                 Address offset: 0x24 */</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOCCR</span><span class="p">;</span><span class="w">         </span><span class="cm">/*!&lt; TSC I/O channel control register,                         Address offset: 0x28 */</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">RESERVED4</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; Reserved,                                                 Address offset: 0x2C */</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOGCSR</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; TSC I/O group control status register,                    Address offset: 0x30 */</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">IOGXCR</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">     </span><span class="cm">/*!&lt; TSC I/O group x counter register,                         Address offset: 0x34-50 */</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="p">}</span><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="p">;</span>
</span></code></pre></div>
<p>Pretty simple and efficient so far. This macro will expand into a simple pointer to the memory mapped registers of the TSC peripheral after preprocessor does its job.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="p">((</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_N_S_soc_S_tsc_40024000_REG_IDX_0_VAL_ADDRESS</span><span class="p">)</span><span class="w"> </span><span class="c1">// 0x40024000</span>
</span></code></pre></div>
<h4 id="clock-and-reset-control">Clock and Reset Control</h4>
<p>We now need the <code>clocks</code> property to get the device responsible for clock control in the system, we already passed the clock controller <code>RCC</code> as a reference to the TSC device node.</p>
<p>Clock and reset control is common to ARM based MCUs so Zephyr provides a <a href="https://docs.zephyrproject.org/latest/hardware/peripherals/clock_control.html">Clock Control Peripheral API</a> to vendors to develop their own clock and reset control drivers. We can use this API to enable the clock for the TSC peripheral.</p>
<p>Here is the API to enable the clock for a subsystem (TSC in our case);</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="cm">/* zephyr/drivers/clock_control.h */</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">clock_control_on</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">clock_control_subsys_t</span><span class="w">  </span><span class="n">sys</span><span class="w"> </span><span class="p">);</span>
</span></code></pre></div>
<p>This means we can just pass a generic <code>device</code> that has been defined in the device tree <code>clocks</code> property to the generic <code>clock_control_on</code> with the peripheral and bus information and it will do the job for us. The <code>sys</code> argument is the opaque data to the Clock Control Peripheral API (void pointer) and will be passed to the API implementer that will cast and use the data to enable the clock for the TSC peripheral, this corresponds to the <code>STM32_CLOCK_BUS_AHB1 (0x48)</code> and <code>0x01000000</code> value in the device tree node. We can extract these values on our own but ST provides a nice macro to do this for us.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/clock_control/stm32_clock_control.h&gt;</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="cp">#define TSC_CLOCK(node) (struct stm32_pclken) STM32_CLOCK_INFO(0, node);</span>
</span></code></pre></div>
<p>This macro will expand into more device tree macros and will give us the clock information for the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="cm">/* zepryr/include/drivers/clock_control/stm32_clock_control.h */</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="cp">#define STM32_CLOCK_INFO(clk_index, node_id)    \</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="cp"> {        \</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="cp"> .enr = DT_CLOCKS_CELL_BY_IDX(node_id, clk_index, bits),  \</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="cp"> .bus = DT_CLOCKS_CELL_BY_IDX(node_id, clk_index, bus)  \</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="cp"> }</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are only using one clock for this peripheral but multiple can be defined, in that case a different macro <code>STM32_DT_INST_CLOCKS</code> is used instead.</p>
</div>
<p>Which will expand into;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="p">{</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">  </span><span class="p">.</span><span class="n">enr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_clocks_IDX_0_VAL_bus</span><span class="w"> </span><span class="c1">// 0x48</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">  </span><span class="p">.</span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_clocks_IDX_0_VAL_bits</span><span class="w"> </span><span class="c1">// 0x1000000</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>Reset control is even simpler, we again use the <code>resets</code> property to get the device responsible for reset control in the system, and we can use the same API to reset the TSC peripheral. We will use the <a href="https://docs.zephyrproject.org/latest/hardware/peripherals/reset.html">Reset Controller Peripheral API</a> to reset the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/reset.h&gt;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="cp">#define TSC_RESET(node) (const struct reset_dt_spec *) RESET_DT_SPEC_INST_GET_OR(node, NULL)</span>
</span></code></pre></div>
<p>This macro will get the <code>resets</code> property if it exists, <code>NULL</code> otherwise. This is a pointer to the reset controller device that will be used to reset the TSC peripheral. And <a href="https://docs.zephyrproject.org/apidoc/latest/structreset__dt__spec.html"><code>reset_dt_spec</code></a> is a struct that contains the reset controller device and the reset line number, <code>24</code> in our case.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">line_num</span><span class="p">;</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>So this will expand into</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_resets</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">line_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>With this struct we can use variety of reset control APIs to reset the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="cm">/* zephyr/include/drivers/reset.h */</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">reset_status_dt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="n">spec</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">reset_line_assert_dt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="n">spec</span><span class="p">);</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">reset_line_deassert_dt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="n">spec</span><span class="p">);</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">reset_line_toggle_dt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="n">spec</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="pin-controller">Pin Controller</h4>
<p>This is another peripheral we have to deal with, again Zephyr has a <a href="https://docs.zephyrproject.org/latest/hardware/pinctrl/index.html">Pin Controller Peripheral API</a> to handle the pin configuration. We can use this API to configure the pins for the TSC peripheral.</p>
<p>This is a little tricky because the pin controller configs needs to be defined, but there is a macro for it too.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/pinctrl.h&gt;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="cp">#define TSC_PINCTRL_DEFINE(node) PINCTRL_DT_INST_DEFINE(node)</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="cp">#define TSC_PINCTRL(node) ((const struct pinctrl_dev_config *) PINCTRL_DT_INST_DEV_CONFIG_GET(node))</span>
</span></code></pre></div>
<p>We can then use this struct to apply all the pin states at runtime.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">pinctrl_apply_state</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pinctrl_dev_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
</span></code></pre></div>
<p><code>id</code> is the pin control name property, <code>default (0)</code> in our case.</p>
<h4 id="group-configurations">Group Configurations</h4>
<p>From now on we only have basic types and need no additional subsystem or peripheral API.</p>
<p>A driver instance can have many groups, so lets define a struct to hold the group configurations.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="p">{</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">channel_ios</span><span class="p">;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sampling_io</span><span class="p">;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_as_shield</span><span class="p">;</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>To fill this struct we need to access the child nodes of the TSC node in the device tree.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="cp">#define STM32_TSC_GROUP(node) </span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">  </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">channel_ios</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">sampling_io</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">use_as_shield</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">  </span><span class="p">},</span>
</span></code></pre></div>
<p>This macro will expand into the following code;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="p">{</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_group</span><span class="p">,</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_channel_ios</span><span class="p">,</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_sampling_io</span><span class="p">,</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_use_as_shield</span><span class="p">,</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="p">},</span>
</span></code></pre></div>
<p>To define multiple of these, Zephyr provides a macro <code>DT_INST_FOREACH_CHILD_STATUS_OKAY</code> that will iterate over all the child nodes of a parent node and call a function for each child node that has a status of <code>okay</code>.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="cp">#define STM32_TSC_GROUPS(node) (const struct stm32_tsc_group_config[]) { </span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">  </span><span class="n">DT_INST_FOREACH_CHILD_STATUS_OKAY</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">STM32_TSC_GROUP</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>This will eventually expand into;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_group</span><span class="p">,</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_channel_ios</span><span class="p">,</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_sampling_io</span><span class="p">,</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_use_as_shield</span><span class="p">,</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_group</span><span class="p">,</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_channel_ios</span><span class="p">,</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_sampling_io</span><span class="p">,</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_use_as_shield</span><span class="p">,</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="tsc-configuration">TSC Configuration</h4>
<p>Finally we need a struct to hold all the information about the TSC peripheral, including the base address, clock and reset control, pin controller, group configurations and other properties.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="p">{</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">  </span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">tsc</span><span class="p">;</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_pclken</span><span class="w"> </span><span class="o">*</span><span class="n">pclken</span><span class="p">;</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w"> </span><span class="o">*</span><span class="n">reset</span><span class="p">;</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pinctrl_dev_config</span><span class="w"> </span><span class="o">*</span><span class="n">pcfg</span><span class="p">;</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="o">*</span><span class="n">groups</span><span class="p">;</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">groups_size</span><span class="p">;</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pgpsc</span><span class="p">;</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ctph</span><span class="p">;</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ctpl</span><span class="p">;</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sscpsc</span><span class="p">;</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ssd</span><span class="p">;</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">max_count</span><span class="p">;</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">spread_spectrum</span><span class="p">;</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">sync_acq</span><span class="p">;</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">sync_pol</span><span class="p">;</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">iodef_float</span><span class="p">;</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">irq_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="p">};</span>
</span></code></pre></div>
<h4 id="putting-it-all-together">Putting it all together</h4>
<p>Once we put it all together we get a big initialization macro (backlashes are omitted for readability);</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="cp">#define TSC_GROUP(node) </span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">channel_ios</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">sampling_io</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">use_as_shield</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="cp">#define TSC_GROUPS(node) </span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">  </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="n">DT_INST_FOREACH_CHILD_STATUS_OKAY</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">STM32_TSC_GROUP</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="cp">#define TSC_BASE(node) ((TSC_TypeDef *)DT_INST_REG_ADDR(node))</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="cp">#define TSC_CLOCK(node) (struct stm32_pclken) STM32_CLOCK_INFO(0, node)</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="cp">#define TSC_RESET(node) (const struct reset_dt_spec) RESET_DT_SPEC_INST_GET_OR(node, NULL)</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="cp">#define TSC_PINCTRL_DEFINE(node) PINCTRL_DT_INST_DEFINE(node)</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="cp">#define TSC_PINCTRL(node) ((const struct pinctrl_dev_config *) PINCTRL_DT_INST_DEV_CONFIG_GET(node))</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="cp">#define STM32_TSC_INIT(node)</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">stm32_tsc_irq_init_</span><span class="err">##</span><span class="n">node</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">    </span><span class="n">IRQ_CONNECT</span><span class="p">(</span><span class="n">DT_INST_IRQN</span><span class="p">(</span><span class="n">node</span><span class="p">),</span><span class="w"> </span><span class="n">DT_INST_IRQ</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">),</span><span class="w"> </span><span class="n">stm32_tsc_isr</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_DT_INST_GET</span><span class="p">(</span><span class="n">node</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">    </span><span class="n">irq_enable</span><span class="p">(</span><span class="n">DT_INST_IRQN</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="w">  </span><span class="n">TSC_PINCTRL_DEFINE</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="n">groups</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSC_GROUPS</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>
</span><span id="__span-51-31"><a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="n">tsc_config</span><span class="err">##</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-51-32"><a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-51-33"><a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="w">    </span><span class="p">.</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSC_BASE</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span><span id="__span-51-34"><a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a><span class="w">    </span><span class="p">.</span><span class="n">pclken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSC_CLOCK</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span><span id="__span-51-35"><a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a><span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSC_RESET</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span><span id="__span-51-36"><a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a><span class="w">    </span><span class="p">.</span><span class="n">pcfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TSC_PINCTRL</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span><span id="__span-51-37"><a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a><span class="w">    </span><span class="p">.</span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="p">,</span>
</span><span id="__span-51-38"><a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a><span class="w">    </span><span class="p">.</span><span class="n">groups_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_CHILD_NUM_STATUS_OKAY</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span>
</span><span id="__span-51-39"><a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a><span class="w">    </span><span class="p">.</span><span class="n">pgpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">pulse_generator_prescaler</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-51-40"><a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a><span class="w">    </span><span class="p">.</span><span class="n">ctph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">ctph</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-51-41"><a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a><span class="w">    </span><span class="p">.</span><span class="n">ctpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">ctpl</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-51-42"><a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a><span class="w">    </span><span class="p">.</span><span class="n">sscpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum_prescaler</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-51-43"><a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a><span class="w">    </span><span class="p">.</span><span class="n">ssd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum_deviation</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-51-44"><a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a><span class="w">    </span><span class="p">.</span><span class="n">max_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">max_count_value</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span>
</span><span id="__span-51-45"><a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a><span class="w">    </span><span class="p">.</span><span class="n">spread_spectrum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span>
</span><span id="__span-51-46"><a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a><span class="w">    </span><span class="p">.</span><span class="n">sync_acq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">synced_acquisition</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span>
</span><span id="__span-51-47"><a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a><span class="w">    </span><span class="p">.</span><span class="n">sync_pol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">syncpol_rising</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span>
</span><span id="__span-51-48"><a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a><span class="w">    </span><span class="p">.</span><span class="n">iodef_float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_INST_PROP_OR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">iodef_float</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">),</span>
</span><span id="__span-51-49"><a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a><span class="w">    </span><span class="p">.</span><span class="n">irq_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stm32_tsc_irq_init_</span><span class="err">##</span><span class="n">node</span><span class="p">,</span>
</span><span id="__span-51-50"><a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-51-51"><a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a>
</span><span id="__span-51-52"><a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a><span class="w">  </span><span class="n">DEVICE_DT_INST_DEFINE</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">stm32_tsc_init</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stm32_tsc_cfg_</span><span class="err">##</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">POST_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_KERNEL_INIT_PRIORITY_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></div>
<p>When Zephyr starts booting, it will call all drivers' initialization functions, so when we enter <code>main()</code> we will have everything ready for our application. To enable Zephyr to pick up our driver and call it before main <code>DEVICE_DT_INST_DEFINE</code> is used. This macro has parameters <code>node_id</code>, initialization function, power management function (<code>NULL</code> for us), a pointer to device data in RAM (<code>NULL</code> for us), a pointer to device data in FLASH (cast to void pointer as we will see in <a href="#peripheral-apis">Peripheral API</a> section), initialization level, initialization priority, and a pointer to a device API structure (<code>NULL</code> for us).</p>
<p>What all the device tree was is to be able to fill this struct. We have defined the binding file, written the node and generated the <code>devicetree_generated.h</code> file and got all the data we need.</p>
<p>For this specific node if we call <code>STM32_TSC_INIT</code> with our node, the generated code will look like this;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_irq_init_0</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">  </span><span class="n">IRQ_CONNECT</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stm32_tsc_isr</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_DT_INST_GET</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">  </span><span class="n">irq_enable</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="p">};</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="n">groups</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="p">{</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_group</span><span class="p">,</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_channel_ios</span><span class="p">,</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_sampling_io</span><span class="p">,</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g1_use_as_shield</span><span class="p">,</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="p">.</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_group</span><span class="p">,</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">    </span><span class="p">.</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_channel_ios</span><span class="p">,</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">    </span><span class="p">.</span><span class="n">sampling_io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_sampling_io</span><span class="p">,</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">    </span><span class="p">.</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_g6_use_as_shield</span><span class="p">,</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="p">};</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="n">tsc_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="p">{</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a><span class="w">  </span><span class="p">.</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_N_S_soc_S_tsc_40024000_REG_IDX_0_VAL_ADDRESS</span><span class="p">,</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a><span class="w">  </span><span class="p">.</span><span class="n">pclken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DT_N_S_soc_S_tsc_40024000_P_clocks</span><span class="p">,</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="w">  </span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_resets</span><span class="p">,</span>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="w">  </span><span class="p">.</span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groups</span><span class="p">,</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="w">  </span><span class="p">.</span><span class="n">irq_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsc_isr</span><span class="p">,</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a><span class="w">  </span><span class="p">.</span><span class="n">groups_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a><span class="w">  </span><span class="p">.</span><span class="n">pgpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_pulse_generator_prescaler</span><span class="p">,</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a><span class="w">  </span><span class="p">.</span><span class="n">ctph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_ctph</span><span class="p">,</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a><span class="w">  </span><span class="p">.</span><span class="n">ctpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_ctpl</span><span class="p">,</span>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="w">  </span><span class="p">.</span><span class="n">sscpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_spread_spectrum_prescaler</span><span class="p">,</span>
</span><span id="__span-52-34"><a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a><span class="w">  </span><span class="p">.</span><span class="n">ssd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_spread_spectrum_deviation</span><span class="p">,</span>
</span><span id="__span-52-35"><a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a><span class="w">  </span><span class="p">.</span><span class="n">max_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_max_count_value</span><span class="p">,</span>
</span><span id="__span-52-36"><a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a><span class="w">  </span><span class="p">.</span><span class="n">spread_spectrum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_spread_spectrum</span><span class="p">,</span>
</span><span id="__span-52-37"><a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a><span class="w">  </span><span class="p">.</span><span class="n">sync_acq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_synced_acquisition</span><span class="p">,</span>
</span><span id="__span-52-38"><a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a><span class="w">  </span><span class="p">.</span><span class="n">sync_pol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_syncpol_rising</span><span class="p">,</span>
</span><span id="__span-52-39"><a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a><span class="w">  </span><span class="p">.</span><span class="n">iodef_float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_N_S_soc_S_tsc_40024000_P_iodef_float</span><span class="p">,</span>
</span><span id="__span-52-40"><a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a><span class="w">  </span><span class="p">.</span><span class="n">irq_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stm32_tsc_irq_init_0</span><span class="p">,</span>
</span><span id="__span-52-41"><a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a><span class="p">};</span>
</span><span id="__span-52-42"><a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>
</span><span id="__span-52-43"><a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a><span class="cm">/* device defininition code */</span>
</span></code></pre></div>
<p>This is very roughly what ends up happening after preprocessor does its job.</p>
<h5 id="interrupts">Interrupts</h5>
<p>One important thing not mentioned here is interrupts. We defined in the node that the interrupts are at position <code>21</code> and the priority is <code>0</code>. Zephyr has a <a href="https://docs.zephyrproject.org/latest/kernel/services/interrupts.html">nice API</a> to connect interrupts to ISRs and enable them. In this implementation all interrupts are connected to <code>stm32_tsc_isr</code> function, which is a generic interrupt service routine, and it will take a parameter of type <code>const struct device *</code> (provided by passing <code>DEVICE_DT_INST_GET</code> to <code>ISR_CONNECT</code> ) so we will be able to serve multiple instances of the TSC peripheral with the same ISR. So if we call <code>stm32_tsc_irq_init_0</code> function, it will connect the interrupt to the ISR and enable it.</p>
<p>I plan to be able to enable and disable interrupts from the Kconfig files which what Zephyr uses to configure the kernel at compile time.</p>
<h3 id="device-driver-implementation">Device Driver Implementation</h3>
<p>Now that we have our device tree node and binding ready, data plumbed to the driver, and the device defined, we can start writing the driver code.</p>
<p>We will again start by creating a directory for our driver in the workspace in the <code>zephyr/drivers/misc</code> folder for a cohesive folder structure. These are not mandatory but it is good practice to keep things organized.</p>
<p>We can start writing the code right away. I'll just create <code>stm32_tsc.c</code> file in the <code>drivers/misc/stm32_tsc</code> directory.</p>
<p>I like to start with the <code>DT_DRV_COMPAT</code> macro to define the compatible string for the driver, this is the same string we used in the binding file but special characters are replaced with underscores. And include the plumbing code so we can have the data ready.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="cm">/* zephyr/drivers/misc/stm32_tsc/stm32_tsc.c */</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="cp">#define DT_DRV_COMPAT st_stm32_tsc</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/irq.h&gt;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/reset.h&gt;</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/pinctrl.h&gt;</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/clock_control/stm32_clock_control.h&gt;</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">group</span><span class="p">;</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">channel_ios</span><span class="p">;</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">sampling_io</span><span class="p">;</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">     </span><span class="n">use_as_shield</span><span class="p">;</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">zephyr_code</span><span class="p">;</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="p">};</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="w">       </span><span class="o">*</span><span class="n">tsc</span><span class="p">;</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_prcc_deven</span><span class="w">     </span><span class="n">pclken</span><span class="p">;</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">reset_dt_spec</span><span class="w">      </span><span class="n">reset</span><span class="p">;</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pinctrl_dev_config</span><span class="w">     </span><span class="o">*</span><span class="n">pcfg</span><span class="p">;</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="o">*</span><span class="n">groups</span><span class="p">;</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">groups_size</span><span class="p">;</span>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>
</span><span id="__span-53-27"><a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">pgpsc</span><span class="p">;</span>
</span><span id="__span-53-28"><a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">ctph</span><span class="p">;</span>
</span><span id="__span-53-29"><a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">ctpl</span><span class="p">;</span>
</span><span id="__span-53-30"><a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">        </span><span class="n">spread_spectrum</span><span class="p">;</span>
</span><span id="__span-53-31"><a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">sscpsc</span><span class="p">;</span>
</span><span id="__span-53-32"><a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">        </span><span class="n">ssd</span><span class="p">;</span>
</span><span id="__span-53-33"><a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w">        </span><span class="n">max_count</span><span class="p">;</span>
</span><span id="__span-53-34"><a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">        </span><span class="n">iodef</span><span class="p">;</span>
</span><span id="__span-53-35"><a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">        </span><span class="n">sync_acq</span><span class="p">;</span>
</span><span id="__span-53-36"><a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">        </span><span class="n">sync_pol</span><span class="p">;</span>
</span><span id="__span-53-37"><a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">irq_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span><span id="__span-53-38"><a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a><span class="p">};</span>
</span><span id="__span-53-39"><a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>
</span><span id="__span-53-40"><a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a><span class="cp">#define STM32_TSC_GROUP(node)                                 \</span>
</span><span id="__span-53-41"><a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a><span class="cp">  {                                                           \</span>
</span><span id="__span-53-42"><a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a><span class="cp">    .group = DT_PROP(node, group),                            \</span>
</span><span id="__span-53-43"><a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a><span class="cp">    .channel_ios = DT_PROP(node, channel_ios),                \</span>
</span><span id="__span-53-44"><a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a><span class="cp">    .sampling_io = DT_PROP(node, sampling_io),                \</span>
</span><span id="__span-53-45"><a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a><span class="cp">    .use_as_shield = DT_PROP(node, use_as_shield),            \</span>
</span><span id="__span-53-46"><a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a><span class="cp">  },</span>
</span><span id="__span-53-47"><a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a>
</span><span id="__span-53-48"><a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a><span class="cp">#define STM32_TSC_GROUPS(node)                                \</span>
</span><span id="__span-53-49"><a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a><span class="cp">  (const struct stm32_tsc_group_config[]) {                   \</span>
</span><span id="__span-53-50"><a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a><span class="cp">    DT_INST_FOREACH_CHILD_STATUS_OKAY(node, STM32_TSC_GROUP)  \</span>
</span><span id="__span-53-51"><a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a><span class="cp">  }</span>
</span><span id="__span-53-52"><a id="__codelineno-53-52" name="__codelineno-53-52" href="#__codelineno-53-52"></a>
</span><span id="__span-53-53"><a id="__codelineno-53-53" name="__codelineno-53-53" href="#__codelineno-53-53"></a><span class="cp">#define STM32_TSC_BASE(node) ((TSC_TypeDef *)DT_INST_REG_ADDR(node))</span>
</span><span id="__span-53-54"><a id="__codelineno-53-54" name="__codelineno-53-54" href="#__codelineno-53-54"></a><span class="cp">#define STM32_TSC_CLOCK(node) (const struct stm32_pclken) STM32_CLOCK_INFO(0, DT_DRV_INST(node))</span>
</span><span id="__span-53-55"><a id="__codelineno-53-55" name="__codelineno-53-55" href="#__codelineno-53-55"></a><span class="cp">#define STM32_TSC_RESET(node) (const struct reset_dt_spec) RESET_DT_SPEC_INST_GET_OR(node, NULL)</span>
</span><span id="__span-53-56"><a id="__codelineno-53-56" name="__codelineno-53-56" href="#__codelineno-53-56"></a><span class="cp">#define STM32_TSC_PINCTRL_DEFINE(node) PINCTRL_DT_INST_DEFINE(node)</span>
</span><span id="__span-53-57"><a id="__codelineno-53-57" name="__codelineno-53-57" href="#__codelineno-53-57"></a><span class="cp">#define STM32_TSC_PINCTRL(node) ((const struct pinctrl_dev_config *) PINCTRL_DT_INST_DEV_CONFIG_GET(node))</span>
</span><span id="__span-53-58"><a id="__codelineno-53-58" name="__codelineno-53-58" href="#__codelineno-53-58"></a>
</span><span id="__span-53-59"><a id="__codelineno-53-59" name="__codelineno-53-59" href="#__codelineno-53-59"></a><span class="cp">#define STM32_TSC_INIT(node)                                                                                        \</span>
</span><span id="__span-53-60"><a id="__codelineno-53-60" name="__codelineno-53-60" href="#__codelineno-53-60"></a><span class="cp">                                                                                                                    \</span>
</span><span id="__span-53-61"><a id="__codelineno-53-61" name="__codelineno-53-61" href="#__codelineno-53-61"></a><span class="cp">  static void stm32_tsc_irq_init_##node(void) {                                                                     \</span>
</span><span id="__span-53-62"><a id="__codelineno-53-62" name="__codelineno-53-62" href="#__codelineno-53-62"></a><span class="cp">    IRQ_CONNECT(DT_INST_IRQN(node), DT_INST_IRQ(node, priority), stm32_tsc_isr, DEVICE_DT_INST_GET(node), 0);       \</span>
</span><span id="__span-53-63"><a id="__codelineno-53-63" name="__codelineno-53-63" href="#__codelineno-53-63"></a><span class="cp">    irq_enable(DT_INST_IRQN(node));                                                                                 \</span>
</span><span id="__span-53-64"><a id="__codelineno-53-64" name="__codelineno-53-64" href="#__codelineno-53-64"></a><span class="cp">  };                                                                                                                \</span>
</span><span id="__span-53-65"><a id="__codelineno-53-65" name="__codelineno-53-65" href="#__codelineno-53-65"></a><span class="cp">                                                                                                                    \</span>
</span><span id="__span-53-66"><a id="__codelineno-53-66" name="__codelineno-53-66" href="#__codelineno-53-66"></a><span class="cp">  STM32_TSC_PINCTRL_DEFINE(node);                                                                                   \</span>
</span><span id="__span-53-67"><a id="__codelineno-53-67" name="__codelineno-53-67" href="#__codelineno-53-67"></a><span class="cp">                                                                                                                    \</span>
</span><span id="__span-53-68"><a id="__codelineno-53-68" name="__codelineno-53-68" href="#__codelineno-53-68"></a><span class="cp">  static const struct stm32_tsc_group_config groups[] = STM32_TSC_GROUPS(node);                                     \</span>
</span><span id="__span-53-69"><a id="__codelineno-53-69" name="__codelineno-53-69" href="#__codelineno-53-69"></a><span class="cp">                                                                                                                    \</span>
</span><span id="__span-53-70"><a id="__codelineno-53-70" name="__codelineno-53-70" href="#__codelineno-53-70"></a><span class="cp">  static const struct stm32_tsc_config tsc_config##node =                                                           \</span>
</span><span id="__span-53-71"><a id="__codelineno-53-71" name="__codelineno-53-71" href="#__codelineno-53-71"></a><span class="cp">  {                                                                                                                 \</span>
</span><span id="__span-53-72"><a id="__codelineno-53-72" name="__codelineno-53-72" href="#__codelineno-53-72"></a><span class="cp">  .tsc = STM32_TSC_BASE(node),                                                                                      \</span>
</span><span id="__span-53-73"><a id="__codelineno-53-73" name="__codelineno-53-73" href="#__codelineno-53-73"></a><span class="cp">  .pclken = STM32_TSC_CLOCK(node),                                                                                  \</span>
</span><span id="__span-53-74"><a id="__codelineno-53-74" name="__codelineno-53-74" href="#__codelineno-53-74"></a><span class="cp">  .reset = STM32_TSC_RESET(node),                                                                                   \</span>
</span><span id="__span-53-75"><a id="__codelineno-53-75" name="__codelineno-53-75" href="#__codelineno-53-75"></a><span class="cp">  .pcfg = STM32_TSC_PINCTRL(node),                                                                                  \</span>
</span><span id="__span-53-76"><a id="__codelineno-53-76" name="__codelineno-53-76" href="#__codelineno-53-76"></a><span class="cp">  .groups = groups,                                                                                                 \</span>
</span><span id="__span-53-77"><a id="__codelineno-53-77" name="__codelineno-53-77" href="#__codelineno-53-77"></a><span class="cp">  .groups_size = DT_INST_CHILD_NUM_STATUS_OKAY(node),                                                               \</span>
</span><span id="__span-53-78"><a id="__codelineno-53-78" name="__codelineno-53-78" href="#__codelineno-53-78"></a><span class="cp">  .pgpsc = DT_INST_PROP_OR(node, pulse_generator_prescaler, 2),                                                     \</span>
</span><span id="__span-53-79"><a id="__codelineno-53-79" name="__codelineno-53-79" href="#__codelineno-53-79"></a><span class="cp">  .ctph = DT_INST_PROP_OR(node, ctph, 2),                                                                           \</span>
</span><span id="__span-53-80"><a id="__codelineno-53-80" name="__codelineno-53-80" href="#__codelineno-53-80"></a><span class="cp">  .ctpl = DT_INST_PROP_OR(node, ctpl, 2),                                                                           \</span>
</span><span id="__span-53-81"><a id="__codelineno-53-81" name="__codelineno-53-81" href="#__codelineno-53-81"></a><span class="cp">  .spread_spectrum = DT_INST_PROP_OR(node, spread_spectrum, false),                                                 \</span>
</span><span id="__span-53-82"><a id="__codelineno-53-82" name="__codelineno-53-82" href="#__codelineno-53-82"></a><span class="cp">  .sscpsc = DT_INST_PROP_OR(node, spread_spectrum_prescaler, 1),                                                    \</span>
</span><span id="__span-53-83"><a id="__codelineno-53-83" name="__codelineno-53-83" href="#__codelineno-53-83"></a><span class="cp">  .ssd = DT_INST_PROP_OR(node, spread_spectrum_deviation, 1),                                                       \</span>
</span><span id="__span-53-84"><a id="__codelineno-53-84" name="__codelineno-53-84" href="#__codelineno-53-84"></a><span class="cp">  .max_count = DT_INST_PROP_OR(node, max_count_value, 5),                                                           \</span>
</span><span id="__span-53-85"><a id="__codelineno-53-85" name="__codelineno-53-85" href="#__codelineno-53-85"></a><span class="cp">  .iodef = DT_INST_PROP_OR(node, iodef_float, false),                                                               \</span>
</span><span id="__span-53-86"><a id="__codelineno-53-86" name="__codelineno-53-86" href="#__codelineno-53-86"></a><span class="cp">  .sync_acq = DT_INST_PROP_OR(node, synced_acquisition, false),                                                     \</span>
</span><span id="__span-53-87"><a id="__codelineno-53-87" name="__codelineno-53-87" href="#__codelineno-53-87"></a><span class="cp">  .sync_pol = DT_INST_PROP_OR(node, syncpol_rising, false),                                                         \</span>
</span><span id="__span-53-88"><a id="__codelineno-53-88" name="__codelineno-53-88" href="#__codelineno-53-88"></a><span class="cp">  };                                                                                                                \</span>
</span><span id="__span-53-89"><a id="__codelineno-53-89" name="__codelineno-53-89" href="#__codelineno-53-89"></a><span class="cp">                                                                                                                    \</span>
</span><span id="__span-53-90"><a id="__codelineno-53-90" name="__codelineno-53-90" href="#__codelineno-53-90"></a><span class="cp">  DEVICE_DT_INST_DEFINE(node, stm32_tsc_init, NULL, NULL, &amp;tsc_config##node, POST_KERNEL, CONFIG_KERNEL_INIT_PRIORITY_DEFAULT, NULL);</span>
</span><span id="__span-53-91"><a id="__codelineno-53-91" name="__codelineno-53-91" href="#__codelineno-53-91"></a>
</span><span id="__span-53-92"><a id="__codelineno-53-92" name="__codelineno-53-92" href="#__codelineno-53-92"></a><span class="n">DT_INST_FOREACH_STATUS_OKAY</span><span class="p">(</span><span class="n">STM32_TSC_INIT</span><span class="p">)</span>
</span></code></pre></div>
<p><code>DT_INST_FOREACH_STATUS_OKAY</code> is another macro which will iterate over all the instances of the driver in the device tree and call the function for each instance that has a status of <code>okay</code>.</p>
<p>We already defined in some parts of the code that we will use functions named <code>stm32_tsc_isr</code> and <code>stm32_tsc_init</code> so we need to define them. But before doing that a little info about peripheral and subsystem APIs so we can initialize TSC related configurations using other devices like <code>RCC</code>, <code>GPIO</code>, <code>NVIC</code>, etc.</p>
<h4 id="peripheral-and-subsystem-apis">Peripheral and Subsystem APIs</h4>
<p>Peripheral APIs are generic Zephyr APIs that defines a common interface for general "peripherals", like GPIO, PWM, I2C, SPI, etc. These APIs are implemented by the SoC specific HALs so we don't have to change our application code, or driver code, if we change the hardware. We will be only dealing with the Zephyr APIs and it will do the plumbing for us.</p>
<p>These peripheral APIs are usually pretty nice and complete, for example check out the comprehensive GPIO Peripheral API <a href="https://docs.zephyrproject.org/latest/doxygen/html/group__gpio__interface.html">documentation</a>.</p>
<p>To use any GPIO in Zephyr we just need to include the header file and use the API.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zepryr/drivers/gpio.h&gt;</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="p">{</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_get_binding</span><span class="p">(</span><span class="s">&quot;GPIO_0&quot;</span><span class="p">);</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">        </span><span class="n">k_panic</span><span class="p">(</span><span class="s">&quot;Could not get GPIO device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GPIO_ACTIVE_HIGH</span><span class="p">);</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">        </span><span class="n">k_panic</span><span class="p">(</span><span class="s">&quot;Could not configure GPIO pin 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>Once we are able to get a <code>device</code> struct, we can then pass it to its respective API. Notice how <code>struct device</code> is just a generic struct, in fact if we look at the definition of it we see a really abstract structure:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="cm">/**</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="cm"> * @brief Runtime device structure (in ROM) per driver instance</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="cm"> */</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w"> </span><span class="cm">/** Name of the device instance */</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w"> </span><span class="cm">/** Address of device instance config information */</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w"> </span><span class="cm">/** Address of the API structure exposed by the device instance */</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">;</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w"> </span><span class="cm">/** Address of the common device state */</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_state</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="p">;</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w"> </span><span class="cm">/** Address of the device instance private data */</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="p">};</span>
</span></code></pre></div>
<p><code>config</code>, <code>api</code> and <code>data</code> are all adapters (void pointers) to whatever any "device" wants. And if we look at the <code>gpio_pin_configure</code> function you see after some checking it calls the actual driver that was described in the device tree of the hardware we are using, which was connected to this adapter at boot time, by the device tree macros. We will see this in detail in the next section.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">gpio_pin_configure</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">,</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">     </span><span class="n">gpio_pin_t</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">     </span><span class="n">gpio_flags_t</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="p">{</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_driver_api</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_driver_api</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">api</span><span class="p">;</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">pin_configure</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>So the <code>void *api</code> was assigned to the device structure by the actual vendor driver at boot time and again dereferenced here by the API to get the address of the actual driver function which does the actual configuration. So probably the vendor driver will look into the <code>config</code> field or the <code>data</code> field to get the actual hardware registers and do the configuration.</p>
<p>Strong opinion time; C allowed this kind of abstraction all along, but nobody dared to implement it. I think this was the framework industry needed for a long time, and Zephyr did it right. So hats off to the Zephyr team for this.</p>
<p>The peripheral APIs this driver will use are;</p>
<ul>
<li><a href="https://docs.zephyrproject.org/latest/hardware/peripherals/clock_control.html">Clock Control</a></li>
<li><a href="https://docs.zephyrproject.org/latest/hardware/peripherals/reset.html">Reset Controller</a></li>
<li><a href="https://docs.zephyrproject.org/latest/hardware/pinctrl/index.html">Pin Controller</a></li>
<li><a href="https://docs.zephyrproject.org/latest/kernel/services/interrupts.html">Interrupts</a></li>
</ul>
<p>There are also subsystems, they are pretty similar to peripherals in terms of their use but the difference is that they do not rely on hardware. Things like console or file systems. One subsystem this driver can use is the <a href="https://docs.zephyrproject.org/latest/services/input/index.html#input">Input Subsystem</a>. This subsystem is used for anything that is an input, usually touch screens, buttons, etc. We can use this subsystem to get the touch input from the TSC peripheral.</p>
<h4 id="reset-api">Reset API</h4>
<p>Since we will be using another device we should check if it was initialized before using it. Zephyr has a function for this</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="p">{</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">  </span><span class="n">rcc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">STM32_CLOCK_CONTROL_NODE</span><span class="p">);</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">rcc_dev</span><span class="p">))</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: clock and reset controller device not ready&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">);</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>First thing to do is to get the devices and configs we will use. In this case this device's config point to a memory location that holds the <code>struct stm32_tsc_config</code> we defined earlier, so we will cast the <code>dev-&gt;config</code>, which was a void pointer to this struct and use it. Another one is the <code>rcc_dev</code> which is the clock and reset controller device we will use to reset the TSC peripheral. <code>STM32_CLOCK_CONTROL_NODE</code> is defined in <code>stm32_clock_control.h</code> and points to the device tree node that holds the clock and reset controller information.</p>
<p>After this we will use <code>reset_line_toggle_dt</code> from the reset API to reset the TSC peripheral, so the peripheral values are at their defaults.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Also a subsystem called <code>Log</code> is used here, but since it is irrelevant, I will not discuss it. Please find more information about it in the <a href="https://docs.zephyrproject.org/latest/services/logging/index.html">Zephyr Documentation</a>.</p>
</div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/reset.h&gt;</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="p">{</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">  </span><span class="n">rcc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">STM32_CLOCK_CONTROL_NODE</span><span class="p">);</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset_line_toggle_dt</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to reset TSC@%p (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="clock-control-api">Clock Control API</h4>
<p>Then we will use the clock control API to enable the clock for the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/clock_control.h&gt;</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="p">{</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">  </span><span class="n">rcc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">STM32_CLOCK_CONTROL_NODE</span><span class="p">);</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock_control_on</span><span class="p">(</span><span class="n">rcc_dev</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">clock_control_subsys_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pclken</span><span class="p">);</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to enable clock for TSC@%p (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="pin-controller-api">Pin Controller API</h4>
<p>And finally we will use the pin controller API to configure the pins for the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/pinctrl.h&gt;</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="p">{</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">  </span><span class="n">rcc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">STM32_CLOCK_CONTROL_NODE</span><span class="p">);</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pinctrl_apply_state</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">,</span><span class="w"> </span><span class="n">PINCTRL_STATE_DEFAULT</span><span class="p">);</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to configure TSC@%p pins (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>This will be all for now for the peripheral APIs, the rest of it is just memory writes and reads to/from the TSC peripheral registers and finally calling the interrupt enable function we defined earlier in <code>STM32_TSC_INIT</code>, which makes this final code for the <code>stm32_tsc_init</code> function.</p>
<h4 id="stm32_tsc_init">stm32_tsc_init</h4>
<div class="language-c highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;soc.h&gt;</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">stm32_tsc_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="p">{</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w">     </span><span class="n">rcc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">STM32_CLOCK_CONTROL_NODE</span><span class="p">);</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w"> </span><span class="kt">int</span><span class="w">          </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">rcc_dev</span><span class="p">))</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: clock and reset controller device not ready&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">);</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="w"> </span><span class="cm">/* reset TSC values to default */</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset_line_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to reset TSC@%p (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock_control_on</span><span class="p">(</span><span class="n">rcc_dev</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">clock_control_subsys_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pclken</span><span class="p">);</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to enable clock for TSC@%p (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pinctrl_apply_state</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">,</span><span class="w"> </span><span class="n">PINCTRL_STATE_DEFAULT</span><span class="p">);</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to configure TSC@%p pins (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-61-35"><a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-61-36"><a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-37"><a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a>
</span><span id="__span-61-38"><a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a><span class="w"> </span><span class="cm">/* set ctph (bits 31:28) and ctpl (bits 27:24) */</span>
</span><span id="__span-61-39"><a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="p">(((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ctph</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ctpl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Pos</span><span class="p">);</span>
</span><span id="__span-61-40"><a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a>
</span><span id="__span-61-41"><a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a><span class="w"> </span><span class="cm">/* set spread spectrum deviation (bits 23:17) */</span>
</span><span id="__span-61-42"><a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ssd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TSC_CR_SSD_Pos</span><span class="p">);</span>
</span><span id="__span-61-43"><a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a>
</span><span id="__span-61-44"><a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a><span class="w"> </span><span class="cm">/* set pulse generator prescaler (bits 14:12) */</span>
</span><span id="__span-61-45"><a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pgpsc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TSC_CR_PGPSC_Pos</span><span class="p">);</span>
</span><span id="__span-61-46"><a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a>
</span><span id="__span-61-47"><a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a><span class="w"> </span><span class="cm">/* set max count value (bits 7:5) */</span>
</span><span id="__span-61-48"><a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">max_count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">TSC_CR_MCV_Pos</span><span class="p">);</span>
</span><span id="__span-61-49"><a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>
</span><span id="__span-61-50"><a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a><span class="w"> </span><span class="cm">/* set spread spectrum prescaler (bit 15) */</span>
</span><span id="__span-61-51"><a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sscpsc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-61-52"><a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_SSPSC_Pos</span><span class="p">);</span>
</span><span id="__span-61-53"><a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a>
</span><span id="__span-61-54"><a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a><span class="w"> </span><span class="cm">/* set sync bit polarity */</span>
</span><span id="__span-61-55"><a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sync_pol</span><span class="p">)</span>
</span><span id="__span-61-56"><a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_SYNCPOL_Pos</span><span class="p">);</span>
</span><span id="__span-61-57"><a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>
</span><span id="__span-61-58"><a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a><span class="w"> </span><span class="cm">/* set sync acquisition */</span>
</span><span id="__span-61-59"><a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sync_acq</span><span class="p">)</span>
</span><span id="__span-61-60"><a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_AM_Pos</span><span class="p">);</span>
</span><span id="__span-61-61"><a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a>
</span><span id="__span-61-62"><a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a><span class="w"> </span><span class="cm">/* set I/O default mode */</span>
</span><span id="__span-61-63"><a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">iodef</span><span class="p">)</span>
</span><span id="__span-61-64"><a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_IODEF_Pos</span><span class="p">);</span>
</span><span id="__span-61-65"><a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a>
</span><span id="__span-61-66"><a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a><span class="w"> </span><span class="cm">/* set spread spectrum */</span>
</span><span id="__span-61-67"><a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">spread_spectrum</span><span class="p">)</span>
</span><span id="__span-61-68"><a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_SSE_Pos</span><span class="p">);</span>
</span><span id="__span-61-69"><a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a>
</span><span id="__span-61-70"><a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a><span class="w"> </span><span class="cm">/* group configuration */</span>
</span><span id="__span-61-71"><a id="__codelineno-61-71" name="__codelineno-61-71" href="#__codelineno-61-71"></a><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">groups_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-61-72"><a id="__codelineno-61-72" name="__codelineno-61-72" href="#__codelineno-61-72"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-73"><a id="__codelineno-61-73" name="__codelineno-61-73" href="#__codelineno-61-73"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="o">*</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-61-74"><a id="__codelineno-61-74" name="__codelineno-61-74" href="#__codelineno-61-74"></a>
</span><span id="__span-61-75"><a id="__codelineno-61-75" name="__codelineno-61-75" href="#__codelineno-61-75"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">sampling_io</span><span class="p">)</span>
</span><span id="__span-61-76"><a id="__codelineno-61-76" name="__codelineno-61-76" href="#__codelineno-61-76"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-61-77"><a id="__codelineno-61-77" name="__codelineno-61-77" href="#__codelineno-61-77"></a><span class="w">   </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: group %d has the same channel and sampling I/O&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
</span><span id="__span-61-78"><a id="__codelineno-61-78" name="__codelineno-61-78" href="#__codelineno-61-78"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-61-79"><a id="__codelineno-61-79" name="__codelineno-61-79" href="#__codelineno-61-79"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-61-80"><a id="__codelineno-61-80" name="__codelineno-61-80" href="#__codelineno-61-80"></a>
</span><span id="__span-61-81"><a id="__codelineno-61-81" name="__codelineno-61-81" href="#__codelineno-61-81"></a><span class="w">  </span><span class="cm">/* if use_as_shield is true, the channel I/Os are used as shield, and can only have values 1,2,4,8 */</span>
</span><span id="__span-61-82"><a id="__codelineno-61-82" name="__codelineno-61-82" href="#__codelineno-61-82"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">use_as_shield</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-83"><a id="__codelineno-61-83" name="__codelineno-61-83" href="#__codelineno-61-83"></a><span class="w">      </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-84"><a id="__codelineno-61-84" name="__codelineno-61-84" href="#__codelineno-61-84"></a><span class="w">      </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-85"><a id="__codelineno-61-85" name="__codelineno-61-85" href="#__codelineno-61-85"></a><span class="w">      </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-86"><a id="__codelineno-61-86" name="__codelineno-61-86" href="#__codelineno-61-86"></a><span class="w">      </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
</span><span id="__span-61-87"><a id="__codelineno-61-87" name="__codelineno-61-87" href="#__codelineno-61-87"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-61-88"><a id="__codelineno-61-88" name="__codelineno-61-88" href="#__codelineno-61-88"></a><span class="w">   </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: group %d is used as shield, but has invalid channel I/Os. Can only have one&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
</span><span id="__span-61-89"><a id="__codelineno-61-89" name="__codelineno-61-89" href="#__codelineno-61-89"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-61-90"><a id="__codelineno-61-90" name="__codelineno-61-90" href="#__codelineno-61-90"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-61-91"><a id="__codelineno-61-91" name="__codelineno-61-91" href="#__codelineno-61-91"></a>
</span><span id="__span-61-92"><a id="__codelineno-61-92" name="__codelineno-61-92" href="#__codelineno-61-92"></a><span class="w">  </span><span class="cm">/* each group only has 4 configurable I/O */</span>
</span><span id="__span-61-93"><a id="__codelineno-61-93" name="__codelineno-61-93" href="#__codelineno-61-93"></a><span class="cp">#define GET_GROUP_BITS(val) (uint32_t)(((val) &amp; 0x0f) &lt;&lt; ((group-&gt;group - 1) * 4))</span>
</span><span id="__span-61-94"><a id="__codelineno-61-94" name="__codelineno-61-94" href="#__codelineno-61-94"></a>
</span><span id="__span-61-95"><a id="__codelineno-61-95" name="__codelineno-61-95" href="#__codelineno-61-95"></a><span class="w">  </span><span class="cm">/* clear schmitt trigger hysteresis for enabled I/Os */</span>
</span><span id="__span-61-96"><a id="__codelineno-61-96" name="__codelineno-61-96" href="#__codelineno-61-96"></a><span class="w">  </span><span class="n">sys_clear_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOHCR</span><span class="p">,</span><span class="w"> </span><span class="n">GET_GROUP_BITS</span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">sampling_io</span><span class="p">));</span>
</span><span id="__span-61-97"><a id="__codelineno-61-97" name="__codelineno-61-97" href="#__codelineno-61-97"></a>
</span><span id="__span-61-98"><a id="__codelineno-61-98" name="__codelineno-61-98" href="#__codelineno-61-98"></a><span class="w">  </span><span class="cm">/* set channel I/Os */</span>
</span><span id="__span-61-99"><a id="__codelineno-61-99" name="__codelineno-61-99" href="#__codelineno-61-99"></a><span class="w">  </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOCCR</span><span class="p">,</span><span class="w"> </span><span class="n">GET_GROUP_BITS</span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">channel_ios</span><span class="p">));</span>
</span><span id="__span-61-100"><a id="__codelineno-61-100" name="__codelineno-61-100" href="#__codelineno-61-100"></a>
</span><span id="__span-61-101"><a id="__codelineno-61-101" name="__codelineno-61-101" href="#__codelineno-61-101"></a><span class="w">  </span><span class="cm">/* set sampling I/O */</span>
</span><span id="__span-61-102"><a id="__codelineno-61-102" name="__codelineno-61-102" href="#__codelineno-61-102"></a><span class="w">  </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOSCR</span><span class="p">,</span><span class="w"> </span><span class="n">GET_GROUP_BITS</span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">sampling_io</span><span class="p">));</span>
</span><span id="__span-61-103"><a id="__codelineno-61-103" name="__codelineno-61-103" href="#__codelineno-61-103"></a>
</span><span id="__span-61-104"><a id="__codelineno-61-104" name="__codelineno-61-104" href="#__codelineno-61-104"></a><span class="w">  </span><span class="cm">/* enable group */</span>
</span><span id="__span-61-105"><a id="__codelineno-61-105" name="__codelineno-61-105" href="#__codelineno-61-105"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">use_as_shield</span><span class="p">)</span>
</span><span id="__span-61-106"><a id="__codelineno-61-106" name="__codelineno-61-106" href="#__codelineno-61-106"></a><span class="w">   </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOGCSR</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-61-107"><a id="__codelineno-61-107" name="__codelineno-61-107" href="#__codelineno-61-107"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-108"><a id="__codelineno-61-108" name="__codelineno-61-108" href="#__codelineno-61-108"></a>
</span><span id="__span-61-109"><a id="__codelineno-61-109" name="__codelineno-61-109" href="#__codelineno-61-109"></a><span class="w"> </span><span class="cm">/* disable interrupts */</span>
</span><span id="__span-61-110"><a id="__codelineno-61-110" name="__codelineno-61-110" href="#__codelineno-61-110"></a><span class="w"> </span><span class="n">sys_clear_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_IER_EOAIE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TSC_IER_MCEIE</span><span class="p">);</span>
</span><span id="__span-61-111"><a id="__codelineno-61-111" name="__codelineno-61-111" href="#__codelineno-61-111"></a>
</span><span id="__span-61-112"><a id="__codelineno-61-112" name="__codelineno-61-112" href="#__codelineno-61-112"></a><span class="w"> </span><span class="cm">/* clear interrupts */</span>
</span><span id="__span-61-113"><a id="__codelineno-61-113" name="__codelineno-61-113" href="#__codelineno-61-113"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_EOAIC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TSC_ICR_MCEIC</span><span class="p">);</span>
</span><span id="__span-61-114"><a id="__codelineno-61-114" name="__codelineno-61-114" href="#__codelineno-61-114"></a>
</span><span id="__span-61-115"><a id="__codelineno-61-115" name="__codelineno-61-115" href="#__codelineno-61-115"></a><span class="w"> </span><span class="cm">/* enable peripheral */</span>
</span><span id="__span-61-116"><a id="__codelineno-61-116" name="__codelineno-61-116" href="#__codelineno-61-116"></a><span class="w"> </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_TSCE_Pos</span><span class="p">);</span>
</span><span id="__span-61-117"><a id="__codelineno-61-117" name="__codelineno-61-117" href="#__codelineno-61-117"></a>
</span><span id="__span-61-118"><a id="__codelineno-61-118" name="__codelineno-61-118" href="#__codelineno-61-118"></a><span class="cp">#if IS_ENABLED(CONFIG_STM32_TSC_INTERRUPT)</span>
</span><span id="__span-61-119"><a id="__codelineno-61-119" name="__codelineno-61-119" href="#__codelineno-61-119"></a><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">irq_func</span><span class="p">();</span>
</span><span id="__span-61-120"><a id="__codelineno-61-120" name="__codelineno-61-120" href="#__codelineno-61-120"></a><span class="cp">#endif</span>
</span><span id="__span-61-121"><a id="__codelineno-61-121" name="__codelineno-61-121" href="#__codelineno-61-121"></a>
</span><span id="__span-61-122"><a id="__codelineno-61-122" name="__codelineno-61-122" href="#__codelineno-61-122"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-61-123"><a id="__codelineno-61-123" name="__codelineno-61-123" href="#__codelineno-61-123"></a><span class="p">}</span>
</span></code></pre></div>
<p>The functions like <code>sys_set_bits</code> and <code>sys_clear_bits</code> are just memory writes to the peripheral registers and definitions like <code>TSC_IER_EOAIE</code> or <code>TSC_CR_IODEF_Pos</code> are taken from the SOC specific header file, which gets included with <code>soc.h</code> which corresponds to the <code>stm32u083xx.h</code> file in this case.</p>
<p>If you noticed the interrupt is only enabled when there is a definition  called <code>CONFIG_STM32_TSC_INTERRUPT</code>. We will not define it in this file instead it will be defined globally by the Zephyr build system when parsing Kconfig files which we will see in the next section.</p>
<h4 id="tsc-peripheral-api">TSC Peripheral API</h4>
<p>This is not quite a set-and-forget type of a driver. Application implementer should start the acquisition. Therefore the driver should expose some functions to interact with the TSC peripheral.</p>
<p>Header files are resided in <code>include</code> directory of the Zephyr source, therefore this driver will be in <code>zephyr/include/drivers/misc/stm32_tsc.h</code>.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="cm">/* zephyr/include/drivers/misc/stm32_tsc.h */</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="cp">#ifndef ZEPHYR_DRIVERS_MISC_STM32_TSC_H_</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="cp">#define ZEPHYR_DRIVERS_MISC_STM32_TSC_H_</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/types.h&gt;</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="kt">int</span><span class="w">  </span><span class="nf">stm32_tsc_poll_for_acquisition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">k_timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="kt">int</span><span class="w">  </span><span class="nf">stm32_tsc_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="cp">#endif </span><span class="cm">/* ZEPHYR_DRIVERS_MISC_STM32_TSC_H_ */</span>
</span></code></pre></div>
<p>This API is as simple as it can get. All functions require a <code>device</code> to work. <code>stm32_tsc_start</code> will start the acquisition, and if interrupt is enabled it should put the acquisition value to the input subsystem, or user can poll and read manually.</p>
<h4 id="tsc-peripheral-api-implementation">TSC Peripheral API Implementation</h4>
<h5 id="stm32_tsc_start">stm32_tsc_start</h5>
<div class="language-c highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="p">{</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w"> </span><span class="cm">/* clear interrupts */</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_EOAIC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TSC_ICR_MCEIC</span><span class="p">);</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="cp">#if IS_ENABLED(CONFIG_STM32_TSC_INTERRUPT)</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w"> </span><span class="cm">/* enable end of acquisition and max count error interrupts */</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w"> </span><span class="n">sys_set_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_IER_EOAIE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TSC_IER_MCEIE</span><span class="p">);</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="cp">#endif</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w"> </span><span class="cm">/* start acquisition */</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w"> </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_CR_START_Pos</span><span class="p">);</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>This is discussed in the previous sections, we clear and enable interrupts if enabled, only only set a bit to start the acquisition.</p>
<h5 id="stm32_tsc_poll_for_acquisition">stm32_tsc_poll_for_acquisition</h5>
<p>When error or acquisition occurs the <code>ISR</code> register bits are set. Driver will check those and return if the bits are set (clearing them before returning) or a timeout occurs.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">stm32_tsc_poll_for_acquisition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">k_timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="p">{</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w">         </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w">         </span><span class="n">start_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_clock_tick_get_32</span><span class="p">();</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w"> </span><span class="k">do</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_read32</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ISR</span><span class="p">);</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys_clock_tick_get_32</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_tick</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout</span><span class="p">.</span><span class="n">ticks</span><span class="p">)</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">   </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: timeout&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">);</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_ISR_EOAF</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF</span><span class="p">));</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF</span><span class="p">)</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_MCEIC_Pos</span><span class="p">);</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: max count error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">);</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="w"> </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_EOAIC_Pos</span><span class="p">);</span>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-64-29"><a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="stm32_tsc_read">stm32_tsc_read</h5>
<p>Reading is also straightforward, we just read the data register of the TSC group.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">stm32_tsc_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="p">{</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w"> </span><span class="cm">/* make sure group starts with 1 and can go max to IOGXCR count */</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_read32</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOGXCR</span><span class="p">[</span><span class="n">group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="stm32_tsc_isr">stm32_tsc_isr</h5>
<p>This function just disables the interrupts and checks for errors just like in the polling function, and if there is no error it reads the values and reports them to the input subsystem.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stm32_tsc_isr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="p">{</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_config</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w"> </span><span class="cm">/* disable interrupts */</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w"> </span><span class="n">sys_clear_bits</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_IER_EOAIE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TSC_IER_MCEIE</span><span class="p">);</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys_test_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ISR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ISR_MCEF_Pos</span><span class="p">))</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a><span class="w">  </span><span class="cm">/* clear max count error flag */</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_MCEIC_Pos</span><span class="p">);</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">  </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;TSC@%p: max count error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">);</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="w">  </span><span class="n">LOG_HEXDUMP_DBG</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;TSC Registers&quot;</span><span class="p">);</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys_test_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ISR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ISR_EOAF_Pos</span><span class="p">))</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="w">  </span><span class="cm">/* clear end of acquisition flag */</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="w">  </span><span class="n">sys_set_bit</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ICR</span><span class="p">,</span><span class="w"> </span><span class="n">TSC_ICR_EOAIC_Pos</span><span class="p">);</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="w">  </span><span class="cm">/* read values */</span>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">groups_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stm32_tsc_group_config</span><span class="w"> </span><span class="o">*</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a><span class="w">   </span><span class="kt">uint32_t</span><span class="w">        </span><span class="n">group_bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>
</span><span id="__span-66-28"><a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOGCSR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">group_bit</span><span class="p">)</span>
</span><span id="__span-66-29"><a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a><span class="w">   </span><span class="p">{</span>
</span><span id="__span-66-30"><a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">count_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_read32</span><span class="p">((</span><span class="n">mem_addr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOGXCR</span><span class="p">[</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span>
</span><span id="__span-66-31"><a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a><span class="w">    </span><span class="n">input_report</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_EV_DEVICE</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">-&gt;</span><span class="n">zephyr_code</span><span class="p">,</span><span class="w"> </span><span class="n">count_value</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">K_FOREVER</span><span class="p">);</span>
</span><span id="__span-66-32"><a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-66-33"><a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-66-34"><a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-35"><a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="integration-into-the-build-system">Integration into the Build System</h3>
<p>Zephyr uses Kconfig and CMake to decide if it will compile and link our source code. So this driver needs to integrate itself into this build system.</p>
<p>In total 2 new files need to be created and 2 more needs editing.</p>
<ul>
<li><code>zephyr/drivers/misc/stm32_tsc/CMakeLists.txt</code> for the driver source</li>
<li><code>zephyr/drivers/misc/stm32_tsc/Kconfig</code> for the driver configuration</li>
<li><code>zephyr/drivers/misc/CMakeLists.txt</code> for the driver inclusion</li>
<li><code>zephyr/drivers/misc/Kconfig</code> for the driver inclusion</li>
</ul>
<p>First thing this driver needs is to have a <code>CMakeLists.txt</code> and <code>Kconfig</code> file where the driver source is;</p>
<h4 id="source-cmakeliststxt">Source CMakeLists.txt</h4>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c"># zephyr/drivers/misc/stm32_tsc/CMakeLists.txt</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="nb">zephyr_library</span><span class="p">()</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="nb">zephyr_library_sources</span><span class="p">(</span><span class="s">stm32_tsc.c</span><span class="p">)</span>
</span></code></pre></div>
<p>This will add this as a Zephyr library and include the <code>stm32_tsc.c</code> file in the build system.</p>
<h4 id="source-kconfig">Source Kconfig</h4>
<p>For the Kconfig file, we will create a <code>Kconfig</code> file in the same directory as the <code>CMakeLists.txt</code> file.</p>
<div class="language-Kconfig highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># zephyr/drivers/misc/stm32_tsc/Kconfig</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="k">config</span><span class="w"> </span>STM32_TSC
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="s2">&quot;STM32 TSC driver&quot;</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w"> </span><span class="k">depends on</span><span class="w"> </span>DT_HAS_ST_STM32_TSC_ENABLED
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w"> </span><span class="k">help</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">   </span>Enable<span class="w"> </span>driver<span class="w"> </span>for<span class="w"> </span>STM32<span class="w"> </span>TSC<span class="w"> </span>peripheral.
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="k">if</span><span class="w"> </span>STM32_TSC
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="k">config</span><span class="w"> </span>STM32_TSC_INTERRUPT
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w"> </span><span class="nb">bool</span><span class="w"> </span><span class="s2">&quot;Use interrupt for STM32 TSC&quot;</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w"> </span><span class="k">default</span><span class="w"> </span>y
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="w"> </span><span class="k">help</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">   </span>Use<span class="w"> </span>interrupt<span class="w"> </span>for<span class="w"> </span>STM32<span class="w"> </span>TSC<span class="w"> </span>peripheral.
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="k">endif</span>
</span></code></pre></div>
<p>Kconfig files are easy to read, and in this one we have only two configurations. The first one is to enable the driver, and the second one is to enable the interrupt. The first one depends on <code>DT_HAS_ST_STM32_TSC_ENABLED</code> which requires many more configs to make sure we run on <code>STM32</code> and in the system we have a TSC peripheral.</p>
<h4 id="zephyr-cmakeliststxt">Zephyr CMakeLists.txt</h4>
<p>But the driver did not used <code>STM32_TSC</code> anywhere, so how does Zephyr know to include this driver in the build? This is done in the <code>zephyr/drivers/misc/CMakeLists.txt</code> file. We strategically placed these in subfolders, and these subfolders have their own <code>Kconfig</code> and <code>CMakeLists.txt</code> files. So that subdirs are accumulated as a chain. Therefore this drivers needs to be made aware to the parent directory.</p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c"># zephyr/drivers/misc/CMakeLists.txt</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nb">add_subdirectory_ifdef</span><span class="p">(</span><span class="s">CONFIG_STM32_TSC</span><span class="w"> </span><span class="s">stm32_tsc</span><span class="p">)</span>
</span></code></pre></div>
<p>This is where the definition in the Kconfig file is used. If <code>CONFIG_STM32_TSC</code> is defined, then the <code>stm32_tsc</code> directory will be included in the build. The <code>CONFIG_</code> prefix is attached to every configuration in the Kconfig file.</p>
<h4 id="zephyr-kconfig">Zephyr Kconfig</h4>
<p>Same has to be done with Kconfig but without the conditional inclusion.</p>
<div class="language-Kconfig highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># zephyr/drivers/misc/Kconfig</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">menu</span><span class="w"> </span><span class="s2">&quot;Miscellaneous Drivers&quot;</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>...
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="k">source</span><span class="w"> </span><span class="s2">&quot;drivers/misc/stm32_tsc/Kconfig&quot;</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="k">endmenu</span>
</span></code></pre></div>
<h2 id="how-do-we-test-this">How Do We Test This?</h2>
<p>Zephyr has an extensive testing and emulation framework, allowing us to do all kinds of tricks to confidently say our code works. And without even running it on a real hardware. Of course for this memory mapped peripheral driver, we would have to emulate the entire TSC peripheral, which is outside of the scope of this document, but I plan to write on emulation frameworks in the future.</p>
<p>But first, lets test it on the real hardware.</p>
<h3 id="building">Building</h3>
<p>The driver is written but there also needs to be an application to test it, we could create a new application but lets use an existing one. The <a href="https://docs.zephyrproject.org/latest/samples/subsys/input/input_dump/README.html">Input Dump</a> example is a good candidate for this. It is a simple application that reads every input event and prints it to the console.</p>
<p>One change we need to edit in this application is to start the acquisition of the TSC peripheral, since it needed to be manually started.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="cm">/* zephyr/samples/subsys/input/input_dump/src/main.c */</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/misc/stm32_tsc/stm32_tsc.h&gt;</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="p">{</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Input sample started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">DT_NODELABEL</span><span class="p">(</span><span class="n">tsc</span><span class="p">));</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">))</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;TSC device is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">  </span><span class="cm">/* This will start the acqusition and print the readings to input subsystem */</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a><span class="w">  </span><span class="n">stm32_tsc_start</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">);</span>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="w">    </span><span class="cm">/* You can alternatively disable interrupts and</span>
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="cm">   * poll for acquisition completion. */</span>
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a><span class="cp">#if !IS_ENABLED(CONFIG_STM32_TSC_INTERRUPT)</span>
</span><span id="__span-71-27"><a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stm32_tsc_poll_for_acquisition</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">,</span><span class="w"> </span><span class="n">K_MSEC</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
</span><span id="__span-71-28"><a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-71-29"><a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-71-30"><a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to poll for acquisition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-71-31"><a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-71-32"><a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-71-33"><a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a>
</span><span id="__span-71-34"><a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
</span><span id="__span-71-35"><a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stm32_tsc_read</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-71-36"><a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-71-37"><a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-71-38"><a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to read TSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-71-39"><a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-71-40"><a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-71-41"><a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a>
</span><span id="__span-71-42"><a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;TSC value: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-71-43"><a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a><span class="cp">#endif</span>
</span><span id="__span-71-44"><a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a>
</span><span id="__span-71-45"><a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a><span class="w">  </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span><span id="__span-71-46"><a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-71-47"><a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a>
</span><span id="__span-71-48"><a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-71-49"><a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a><span class="p">}</span>
</span></code></pre></div>
<p>If you remember we kept the <code>status</code> of TSC at <code>disabled</code> in the device tree, so we need to change it to <code>okay</code> in the application overlay to be able to use it in the application.</p>
<div class="language-devicetree highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="cm">/* zephyr/samples/subsys/input/input_dump/boards/stm32u083c_dk.overlay */</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="o">&amp;</span><span class="na">tsc</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w"> </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>Now all its left is to enable the driver in the config file of the application.</p>
<div class="language-Kconfig highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># zephyr/samples/subsys/input/input_dump/prj.conf</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>CONFIG_STM32_TSC=y
</span></code></pre></div>
<p>after all these changes, west is ready to build the application.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>west<span class="w"> </span>build<span class="w"> </span>-b<span class="w"> </span>stm32u083c_dk<span class="w"> </span>zephyr/samples/subsys/input/input_dump
</span></code></pre></div>
<h3 id="flashing">Flashing</h3>
<h4 id="linux">Linux</h4>
<p>If your host is Linux, you can use USB pass-through to flash the device. For this the devcontainer should be started with host's USB bus.</p>
<p>There are several ways to do this but one way is to add it in <code>devcontainer.json</code></p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nt">&quot;mounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;type=bind,source=/dev/bus/usb,target=/dev/bus/usb&quot;</span><span class="p">]</span>
</span></code></pre></div>
<h4 id="windows">Windows</h4>
<p>If your host is Windows, USB pass-through is not possible. But you can use USB/IP to share the USB device with the container. This is a bit more complicated but it is possible. Please read the <a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb">Microsoft's documentation</a> on how to do this.</p>
<h4 id="osx">OSX</h4>
<p>I am not sure if USB pass-through is possible, but USB/IP is currently unavailable on OSX. In this case you are on your own. I recommend pulling the files from the volume and flashing on the host with vendor tools, or opening an openOCD remote server and connecting to it inside the container.</p>
<p>After starting the container with a mount or USB/IP, you can flash the device with the following command.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>west<span class="w"> </span>flash
</span></code></pre></div>
<p>and if you connect to the USB Serial port with a terminal emulator (115200bps), we should see the input events printed on the console.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>***<span class="w"> </span>Booting<span class="w"> </span>Zephyr<span class="w"> </span>OS<span class="w"> </span>build<span class="w"> </span>5466949aefaf<span class="w"> </span>***
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>Input<span class="w"> </span>sample<span class="w"> </span>started
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1813</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1803</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1801</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1811</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1820</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>I:<span class="w"> </span>input<span class="w"> </span>event:<span class="w"> </span><span class="nv">dev</span><span class="o">=</span>tsc@40024000<span class="w">     </span>SYN<span class="w"> </span><span class="nv">type</span><span class="o">=</span>ef<span class="w"> </span><span class="nv">code</span><span class="o">=</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="nv">value</span><span class="o">=</span><span class="m">1815</span>
</span></code></pre></div>
<p>How do we know which group's value is this? From the <a href="#hardware-configuration">schematic</a> it is connected to the group 6, but as you can see the <code>code</code> field for this input event is <code>2</code>, and that is the <code>zephyr,code</code> field in the device tree. So we can check the <code>zephyr,code</code> field of the group 6 in the device tree and see it is <code>2</code>.</p>
<h3 id="integration-testing">Integration Testing</h3>
<p>This step can be done at the beginning of the driver implementation to make sure the driver works as expected. This is called <a href="https://en.wikipedia.org/wiki/Test-driven_development">TDD</a> (Test Driven Development) and it is a good practice to write tests before writing the actual code. But for the sake of this document I'll write the tests here. These tests can also be used to test the further modifications to the driver to make sure there is no regression in the driver when a change is made.</p>
<h4 id="what-to-test">What to Test?</h4>
<p>There are two main options that can be tested in this driver. One is to test the driver API and its behavior, and the other is to test the actual register states for this peripheral, and see if it matches the device tree configuration.</p>
<p>Our initial tests kept interrupt enabled, but in the integration tests we should test with and without this feature; <code>CONFIG_STM32_TSC_INTERRUPT</code>.</p>
<h4 id="test-plan">Test Plan</h4>
<p>Here I outline the simple test plan for this driver. This might seem not enough to some, but should cover most cases.</p>
<ul>
<li>Test MMIO</li>
<li>Check if the registers are set correctly</li>
<li>Test the driver API (interrupt)</li>
<li>Start the acquisition</li>
<li>Test if input events are reported</li>
<li>Test the driver API (polling)</li>
<li>Start the acquisition</li>
<li>Poll for acquisition</li>
<li>Read the values</li>
</ul>
<h4 id="test-application">Test Application</h4>
<p>A test application (or a test suite as Zephyr calls it) is just another application that can either run on the host or on the target. Only difference is the inclusion of the <code>ztest</code> library and the test functions with an additional <code>testcase.yml</code> file for the test runner (<a href="https://docs.zephyrproject.org/latest/develop/test/twister.html">twister</a>) to pick up the application as a test.</p>
<p>I'll create a new application in the <code>tests/drivers/misc/stm32_tsc</code> directory and add my files there.</p>
<h5 id="cmakeliststxt">CMakeLists.txt</h5>
<p>This is just a generic cmake file that used in any other application cmake file.</p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c"># zephyr/tests/drivers/misc/stm32_tsc/CMakeLists.txt</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.20.0</span><span class="p">)</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="nb">find_package</span><span class="p">(</span><span class="s">Zephyr</span><span class="w"> </span><span class="s">REQUIRED</span><span class="w"> </span><span class="s">HINTS</span><span class="w"> </span><span class="o">$ENV{</span><span class="nv">ZEPHYR_BASE</span><span class="o">}</span><span class="p">)</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="nb">project</span><span class="p">(</span><span class="s">stm32_tsc</span><span class="p">)</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">app_sources</span><span class="w"> </span><span class="s">src/*.c</span><span class="p">)</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="nb">target_sources</span><span class="p">(</span><span class="s">app</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="o">${</span><span class="nv">app_sources</span><span class="o">}</span><span class="p">)</span>
</span></code></pre></div>
<h5 id="prjconf">prj.conf</h5>
<p>Since we do not have any emulator for TSC peripheral, we will run all the tests on the hardware.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a># tests/drivers/misc/stm32_tsc/prj.conf
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>CONFIG_STM32_TSC=y
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>CONFIG_ZTEST=y
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>CONFIG_INPUT=y
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>CONFIG_INPUT_MODE_SYNCHRONOUS=y
</span></code></pre></div>
<p>This enables the driver and the test framework, and also the input subsystem to be able to test input events.</p>
<h5 id="device-tree-overlays">Device tree overlays</h5>
<p>This devicetree modification is to make sure we use different values for the configuration than the reset values of the TSC peripheral, so that we can hit the parts of our code that sets the registers.</p>
<p>This includes using <code>synced acquisition</code> as discussed in the <a href="#hardware-configuration">Hardware Configuration</a> section. This requires two different additional pin configurations, one for the sync input pin and the other one is to trigger the sync pin. In the following example I've used generic <a href="https://docs.zephyrproject.org/latest/build/dts/zephyr-user-node.html"><code>zephyr,user</code></a> node to define the trigger pin, which I arbitrarily chose to be <code>GPIOA 10</code> which is exposed in my development kit.</p>
<p>And for the sync pin, I've used <code>PD2</code> but this is not an arbitrary pin and it has been chosen with the help of the <a href="https://www.st.com/resource/en/datasheet/stm32u083kc.pdf">MCU datasheet</a>. Luckily this pin is also exposed in my development kit. </p>
<p>Since we are overwriting <code>pinctrl-0</code> property, we have to re-supply the previous channel pins, we do not have to re define them as they will be defined in the original <code>.dts</code> file.</p>
<div class="language-devicetree highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/boards/stm32u083c_dk.overlay */</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="cp">#include</span><span class="cm"> </span><span class="cpf">&lt;zephyr/dt-bindings/misc/stm32-tsc-defines.h&gt;</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="nf">/</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="w">    </span><span class="nf">zephyr,user</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="w">        </span><span class="cm">/* This will be used to trigger the SYNC pin high and low programmatically. They have to be connected with a jumper cable */</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="w">        </span><span class="n">signal-gpios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">gpioa</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="na">GPIO_ACTIVE_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="p">};</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="o">&amp;</span><span class="nf">tsc</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a><span class="w">    </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="w">    </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tsc_shield_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_shield_cs_pb13</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io1_pd10</span><span class="w"> </span><span class="o">&amp;</span><span class="na">tsc_g6_io2_pd11</span><span class="w"> </span><span class="o">&amp;</span><span class="na">syncpin</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="w">    </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a><span class="w">    </span><span class="n">pulse-generator-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">TSC_PG_PRESC_DIV128</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="w">    </span><span class="n">spread-spectrum</span><span class="p">;</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a><span class="w">    </span><span class="n">spread-spectrum-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a><span class="w">    </span><span class="n">spread-spectrum-deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a><span class="w">    </span><span class="n">max-count-value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">TSC_MCV_16383</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="w">    </span><span class="n">synced-acquisition</span><span class="p">;</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a><span class="w">    </span><span class="n">syncpol-rising</span><span class="p">;</span>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a><span class="p">};</span>
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a><span class="o">&amp;</span><span class="nf">pinctrl</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-80-30"><a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a><span class="w">  </span><span class="nl">syncpin</span><span class="p">:</span><span class="w"> </span><span class="nf">syncpin_pd2</span><span class="cm"> </span><span class="p">{</span>
</span><span id="__span-80-31"><a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a><span class="w">    </span><span class="n">pinmux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">STM32_PINMUX</span><span class="p">(</span><span class="err">&#39;</span><span class="na">D</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="na">AF9</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-80-32"><a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a><span class="w">    </span><span class="n">drive-open-drain</span><span class="p">;</span>
</span><span id="__span-80-33"><a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-80-34"><a id="__codelineno-80-34" name="__codelineno-80-34" href="#__codelineno-80-34"></a><span class="p">};</span>
</span></code></pre></div>
<p>This devicetree modification will make sure the driver will be utilized to its full extent.</p>
<h5 id="testcaseyml">testcase.yml</h5>
<p>This file is searched when the test runner twister is run. There is a pretty comprehensive <a href="https://docs.zephyrproject.org/latest/develop/test/twister.html">documentation</a> on how to write this file.</p>
<p>Here we will use a pretty simple one.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># zephyr/tests/drivers/misc/stm32_tsc/testcase.yml</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="nt">tests</span><span class="p">:</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">  </span><span class="nt">drivers.misc.stm32_tsc</span><span class="p">:</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drivers misc stm32 tsc</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dt_compat_enabled(&quot;st,stm32-tsc&quot;)</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="w">  </span><span class="nt">drivers.misc.stm32_tsc_poll</span><span class="p">:</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drivers misc stm32 tsc poll</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dt_compat_enabled(&quot;st,stm32-tsc&quot;)</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="nt">extra_args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CONFIG_STM32_TSC_INTERRUPT=n</span>
</span></code></pre></div>
<p>We can define multiple tests in a single file and each will be built, flashed and run separately. In this case I've defined two tests with two different configurations. These tests are called <code>drivers.misc.stm32_tsc</code> and <code>drivers.misc.stm32_tsc_poll</code>. The first one will test the driver with interrupt enabled and the second one will test the driver with polling enabled. There are also properties like <code>tags</code> which twister uses to scope and run multiple tests and <code>filter</code> which is used to figure out if the test should be run or not. In this case the test will only run if the device tree node <code>st,stm32-tsc</code> is enabled.</p>
<h4 id="test-cases">Test Cases</h4>
<h5 id="test-setup">Test Setup</h5>
<p>We want to run a setup function before each test, and define out test suite first.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/src/main.c */</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/misc/stm32_tsc/stm32_tsc.h&gt;</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/ztest.h&gt;</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="cp">#if DT_HAS_COMPAT_STATUS_OKAY(st_stm32_tsc)</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="w">  </span><span class="cp">#define TSC_NODE DT_INST(0, st_stm32_tsc)</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="cp">#else</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="w">  </span><span class="cp">#error &quot;Define a TSC device&quot;</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="cp">#endif</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="cp">#define ZEPHYR_USER_NODE DT_PATH(zephyr_user)</span>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="w">  </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">ZEPHYR_USER_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">signal_gpios</span><span class="p">);</span>
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a>
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">stm32_tsc_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-82-20"><a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a><span class="p">{</span>
</span><span id="__span-82-21"><a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a><span class="w">  </span><span class="n">zassert_true</span><span class="p">(</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;STM32 TSC device is not ready&quot;</span><span class="p">);</span>
</span><span id="__span-82-22"><a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a><span class="w">  </span><span class="n">zexpect_ok</span><span class="p">(</span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signal</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_INACTIVE</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Failed to configure signal pin&quot;</span><span class="p">);</span>
</span><span id="__span-82-23"><a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-82-24"><a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a><span class="p">}</span>
</span><span id="__span-82-25"><a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a>
</span><span id="__span-82-26"><a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a><span class="n">ZTEST_SUITE</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">stm32_tsc_setup</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></div>
<p>You can return a special data struct to be used in your tests by returning it in the setup function. Also you can define a teardown function to run after each test. I kept them <code>NULL</code> for now.</p>
<p>Please find more information about the <code>ztest</code> library in the <a href="https://docs.zephyrproject.org/latest/develop/test/ztest.html">Ztest documentation</a>.</p>
<h5 id="first-test-case">First Test Case</h5>
<p>A simple test case has the following structure;</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">test_suite_name</span><span class="p">,</span><span class="w"> </span><span class="n">test_testname</span><span class="p">)</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="p">{</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="w">  </span><span class="cm">/* Test code */</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>By this definition lets keep the first test simple and just check if the device is ready (<code>stm32_tsc_init</code> function returns 0).</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/src/main.c */</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="n">test_1_device_ready</span><span class="p">)</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="p">{</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="w">  </span><span class="n">zassert_true</span><span class="p">(</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;STM32 TSC device is not ready&quot;</span><span class="p">);</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="test-mmio">Test MMIO</h5>
<p>The first thing we will test is the <code>CR</code> register of the TSC peripheral, this register is where most of the configuration is done except for the group configurations, which we will test in the next test.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/src/main.c */</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;soc.h&gt;</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="n">test_2_cr_reg</span><span class="p">)</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="p">{</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="w">  </span><span class="o">*</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_REG_ADDR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">);</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">;</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">pgpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">pulse_generator_prescaler</span><span class="p">);</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">ctph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">ctph</span><span class="p">);</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">ctpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">ctpl</span><span class="p">);</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">ssd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum_deviation</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">   </span><span class="n">spread_spectrum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">sscpsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">spread_spectrum_prescaler</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">max_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">max_count_value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">   </span><span class="n">iodef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">iodef_float</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">   </span><span class="n">sync_pol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">syncpol_rising</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w">   </span><span class="n">sync_acq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DT_PROP_OR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">synced_acquisition</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a><span class="w"> </span><span class="cm">/* check charge transfer pulse high value (bits 31:28) */</span>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a><span class="w"> </span><span class="n">zassert_equal</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Pos</span><span class="p">,</span><span class="w"> </span><span class="n">ctph</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CTPH value is not correct, expected %d, got %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ctph</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Pos</span><span class="p">);</span>
</span><span id="__span-85-20"><a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a>
</span><span id="__span-85-21"><a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a><span class="w"> </span><span class="cm">/* check charge transfer pulse low value (bits 27:24) */</span>
</span><span id="__span-85-22"><a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a><span class="w"> </span><span class="n">zassert_equal</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Pos</span><span class="p">,</span><span class="w"> </span><span class="n">ctpl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CTPL value is not correct, expected %d, got %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ctpl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_CTPL_Pos</span><span class="p">);</span>
</span><span id="__span-85-23"><a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a>
</span><span id="__span-85-24"><a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a><span class="w"> </span><span class="cm">/* check spread spectrum deviation value (bits 23:17) */</span>
</span><span id="__span-85-25"><a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a><span class="w"> </span><span class="n">zassert_equal</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSD_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_SSD_Pos</span><span class="p">,</span><span class="w"> </span><span class="n">ssd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SSD value is not correct, expected %d, got %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ssd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSD_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_SSD_Pos</span><span class="p">);</span>
</span><span id="__span-85-26"><a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a>
</span><span id="__span-85-27"><a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a><span class="w"> </span><span class="cm">/* check spread spectrum enable bit (bit 16) */</span>
</span><span id="__span-85-28"><a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spread_spectrum</span><span class="p">)</span>
</span><span id="__span-85-29"><a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a><span class="w">  </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSE_Msk</span><span class="p">);</span>
</span><span id="__span-85-30"><a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a><span class="w"> </span><span class="k">else</span>
</span><span id="__span-85-31"><a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a><span class="w">  </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSE_Msk</span><span class="p">);</span>
</span><span id="__span-85-32"><a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a>
</span><span id="__span-85-33"><a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a><span class="w"> </span><span class="cm">/* check spread spectrum prescaler value (bits 15) */</span>
</span><span id="__span-85-34"><a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sscpsc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-85-35"><a id="__codelineno-85-35" name="__codelineno-85-35" href="#__codelineno-85-35"></a><span class="w">  </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSPSC_Msk</span><span class="p">);</span>
</span><span id="__span-85-36"><a id="__codelineno-85-36" name="__codelineno-85-36" href="#__codelineno-85-36"></a><span class="w"> </span><span class="k">else</span>
</span><span id="__span-85-37"><a id="__codelineno-85-37" name="__codelineno-85-37" href="#__codelineno-85-37"></a><span class="w">  </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SSPSC_Msk</span><span class="p">);</span>
</span><span id="__span-85-38"><a id="__codelineno-85-38" name="__codelineno-85-38" href="#__codelineno-85-38"></a>
</span><span id="__span-85-39"><a id="__codelineno-85-39" name="__codelineno-85-39" href="#__codelineno-85-39"></a><span class="w"> </span><span class="cm">/* check pulse generator prescaler value (bits 14:12) */</span>
</span><span id="__span-85-40"><a id="__codelineno-85-40" name="__codelineno-85-40" href="#__codelineno-85-40"></a><span class="w"> </span><span class="n">zassert_equal</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_PGPSC_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_PGPSC_Pos</span><span class="p">,</span><span class="w"> </span><span class="n">pgpsc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PGPSC value is not correct, expected %d, got %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pgpsc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_PGPSC_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_PGPSC_Pos</span><span class="p">);</span>
</span><span id="__span-85-41"><a id="__codelineno-85-41" name="__codelineno-85-41" href="#__codelineno-85-41"></a>
</span><span id="__span-85-42"><a id="__codelineno-85-42" name="__codelineno-85-42" href="#__codelineno-85-42"></a><span class="w"> </span><span class="cm">/* check max count value (bits 7:5) */</span>
</span><span id="__span-85-43"><a id="__codelineno-85-43" name="__codelineno-85-43" href="#__codelineno-85-43"></a><span class="w"> </span><span class="n">zassert_equal</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_MCV_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_MCV_Pos</span><span class="p">,</span><span class="w"> </span><span class="n">max_count</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MCV value is not correct, expected %d, got %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">max_count</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_MCV_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_MCV_Pos</span><span class="p">);</span>
</span><span id="__span-85-44"><a id="__codelineno-85-44" name="__codelineno-85-44" href="#__codelineno-85-44"></a>
</span><span id="__span-85-45"><a id="__codelineno-85-45" name="__codelineno-85-45" href="#__codelineno-85-45"></a><span class="w"> </span><span class="cm">/* check I/O default mode bit (bit 4) */</span>
</span><span id="__span-85-46"><a id="__codelineno-85-46" name="__codelineno-85-46" href="#__codelineno-85-46"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iodef</span><span class="p">)</span>
</span><span id="__span-85-47"><a id="__codelineno-85-47" name="__codelineno-85-47" href="#__codelineno-85-47"></a><span class="w">  </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_IODEF_Msk</span><span class="p">);</span>
</span><span id="__span-85-48"><a id="__codelineno-85-48" name="__codelineno-85-48" href="#__codelineno-85-48"></a><span class="w"> </span><span class="k">else</span>
</span><span id="__span-85-49"><a id="__codelineno-85-49" name="__codelineno-85-49" href="#__codelineno-85-49"></a><span class="w">  </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_IODEF_Msk</span><span class="p">);</span>
</span><span id="__span-85-50"><a id="__codelineno-85-50" name="__codelineno-85-50" href="#__codelineno-85-50"></a>
</span><span id="__span-85-51"><a id="__codelineno-85-51" name="__codelineno-85-51" href="#__codelineno-85-51"></a><span class="w"> </span><span class="cm">/* check sync polarity bit (bit 3) */</span>
</span><span id="__span-85-52"><a id="__codelineno-85-52" name="__codelineno-85-52" href="#__codelineno-85-52"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sync_pol</span><span class="p">)</span>
</span><span id="__span-85-53"><a id="__codelineno-85-53" name="__codelineno-85-53" href="#__codelineno-85-53"></a><span class="w">  </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SYNCPOL_Msk</span><span class="p">);</span>
</span><span id="__span-85-54"><a id="__codelineno-85-54" name="__codelineno-85-54" href="#__codelineno-85-54"></a><span class="w"> </span><span class="k">else</span>
</span><span id="__span-85-55"><a id="__codelineno-85-55" name="__codelineno-85-55" href="#__codelineno-85-55"></a><span class="w">  </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_SYNCPOL_Msk</span><span class="p">);</span>
</span><span id="__span-85-56"><a id="__codelineno-85-56" name="__codelineno-85-56" href="#__codelineno-85-56"></a>
</span><span id="__span-85-57"><a id="__codelineno-85-57" name="__codelineno-85-57" href="#__codelineno-85-57"></a><span class="w"> </span><span class="cm">/* check sync acquisition bit (bit 2) */</span>
</span><span id="__span-85-58"><a id="__codelineno-85-58" name="__codelineno-85-58" href="#__codelineno-85-58"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sync_acq</span><span class="p">)</span>
</span><span id="__span-85-59"><a id="__codelineno-85-59" name="__codelineno-85-59" href="#__codelineno-85-59"></a><span class="w">  </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_AM_Msk</span><span class="p">);</span>
</span><span id="__span-85-60"><a id="__codelineno-85-60" name="__codelineno-85-60" href="#__codelineno-85-60"></a><span class="w"> </span><span class="k">else</span>
</span><span id="__span-85-61"><a id="__codelineno-85-61" name="__codelineno-85-61" href="#__codelineno-85-61"></a><span class="w">  </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_AM_Msk</span><span class="p">);</span>
</span><span id="__span-85-62"><a id="__codelineno-85-62" name="__codelineno-85-62" href="#__codelineno-85-62"></a>
</span><span id="__span-85-63"><a id="__codelineno-85-63" name="__codelineno-85-63" href="#__codelineno-85-63"></a><span class="w"> </span><span class="cm">/* check start bit (bit 1) */</span>
</span><span id="__span-85-64"><a id="__codelineno-85-64" name="__codelineno-85-64" href="#__codelineno-85-64"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_START_Msk</span><span class="p">);</span>
</span><span id="__span-85-65"><a id="__codelineno-85-65" name="__codelineno-85-65" href="#__codelineno-85-65"></a>
</span><span id="__span-85-66"><a id="__codelineno-85-66" name="__codelineno-85-66" href="#__codelineno-85-66"></a><span class="w"> </span><span class="cm">/* check TSC enable bit (bit 0) */</span>
</span><span id="__span-85-67"><a id="__codelineno-85-67" name="__codelineno-85-67" href="#__codelineno-85-67"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_TSCE_Msk</span><span class="p">);</span>
</span><span id="__span-85-68"><a id="__codelineno-85-68" name="__codelineno-85-68" href="#__codelineno-85-68"></a><span class="p">}</span>
</span></code></pre></div>
<p>This is a lenghty test, but it is just checking if the values in the device tree are set correctly in the <code>CR</code> register of the TSC peripheral.</p>
<p>To test the group configurations, we need to test the registers like <code>IOCCR</code>, <code>IOSCR</code> and <code>IOGCSR</code> of the TSC peripheral.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/src/main.c */</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="n">test_3_group_registers</span><span class="p">)</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="p">{</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="w">  </span><span class="o">*</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_REG_ADDR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">);</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_iohcr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOHCR</span><span class="p">;</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_ioscr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOSCR</span><span class="p">;</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_ioccr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOCCR</span><span class="p">;</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_iogcsr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IOGCSR</span><span class="p">;</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="cp">#define GET_GROUP_BITS(val) (uint32_t)(((val) &amp; 0x0f) &lt;&lt; ((group - 1) * 4))</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="cp">#define STM32_TSC_GROUP_TEST(node)                                                                                                                                                                                                         \</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="cp"> do                                                                                                                                                                                                                                 \</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="cp"> {                                                                                                                                                                                                                                  \</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="cp">  const uint8_t group = DT_PROP(node, group);                                                                                                                                                                                \</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="cp">  const uint8_t channel_ios = DT_PROP(node, channel_ios);                                                                                                                                                                    \</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="cp">  const uint8_t sampling_io = DT_PROP(node, sampling_io);                                                                                                                                                                    \</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="cp">  const bool    use_as_shield = DT_PROP(node, use_as_shield);                                                                                                                                                                \</span>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a><span class="cp">                                                                                                                                                                                                                                           \</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="cp">  </span><span class="cm">/* check schmitt trigger hysteresis for enabled I/Os */</span><span class="cp">                                                                                                                                                                    \</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a><span class="cp">  zassert_equal((*tsc_iohcr &amp; GET_GROUP_BITS(channel_ios | sampling_io)), 0, &quot;Schmitt trigger hysteresis not disabled, expected %d, got %d&quot;, 0, (*tsc_iohcr &amp; GET_GROUP_BITS(channel_ios | sampling_io)));                   \</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="cp">                                                                                                                                                                                                                                           \</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a><span class="cp">  </span><span class="cm">/* check channel I/Os */</span><span class="cp">                                                                                                                                                                                                   \</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a><span class="cp">  zassert_equal((*tsc_ioccr &amp; GET_GROUP_BITS(channel_ios)), GET_GROUP_BITS(channel_ios), &quot;Channel I/Os value is not correct, expected %d, got %d&quot;, GET_GROUP_BITS(channel_ios), (*tsc_ioccr &amp; GET_GROUP_BITS(channel_ios))); \</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a><span class="cp">                                                                                                                                                                                                                                           \</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a><span class="cp">  </span><span class="cm">/* check sampling I/O */</span><span class="cp">                                                                                                                                                                                                   \</span>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a><span class="cp">  zassert_equal((*tsc_ioscr &amp; GET_GROUP_BITS(sampling_io)), GET_GROUP_BITS(sampling_io), &quot;Sampling I/O value is not correct, expected %d, got %d&quot;, GET_GROUP_BITS(sampling_io), (*tsc_ioscr &amp; GET_GROUP_BITS(sampling_io))); \</span>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a><span class="cp">                                                                                                                                                                                                                                           \</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a><span class="cp">  </span><span class="cm">/* check enabled groups */</span><span class="cp">                                                                                                                                                                                                 \</span>
</span><span id="__span-86-30"><a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a><span class="cp">  if (use_as_shield)                                                                                                                                                                                                         \</span>
</span><span id="__span-86-31"><a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a><span class="cp">   zassert_not_equal((*tsc_iogcsr &amp; BIT(group - 1)), BIT(group - 1), &quot;Group %d is a shield group and should not be enabled&quot;, group);                                                                                  \</span>
</span><span id="__span-86-32"><a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a><span class="cp">  else                                                                                                                                                                                                                       \</span>
</span><span id="__span-86-33"><a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a><span class="cp">   zassert_equal((*tsc_iogcsr &amp; BIT(group - 1)), BIT(group - 1), &quot;Group %d is not enabled&quot;, group);                                                                                                                   \</span>
</span><span id="__span-86-34"><a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a><span class="cp"> } while (0);</span>
</span><span id="__span-86-35"><a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a>
</span><span id="__span-86-36"><a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a><span class="w"> </span><span class="n">DT_FOREACH_CHILD_STATUS_OKAY</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">STM32_TSC_GROUP_TEST</span><span class="p">);</span>
</span><span id="__span-86-37"><a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="api-tests">API Tests</h5>
<p>The first test will be to test the polling function of the driver. For this the setting <code>CONFIG_STM32_TSC_INTERRUPT</code> needs to be set to <code>n</code> before building the application which is what we did in the <a href="#testcaseyml">testcase.yml</a> file.</p>
<p>But this test case will run regardless of any Kconfig settings, so we need to skip the test if the interrupt is enabled.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="cm">/* zephyr/tests/drivers/misc/stm32_tsc/src/main.c */</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="n">test_4_acquisition_polling</span><span class="p">)</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="p">{</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="w"> </span><span class="n">Z_TEST_SKIP_IFDEF</span><span class="p">(</span><span class="n">CONFIG_STM32_TSC_INTERRUPT</span><span class="p">);</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">);</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="w">  </span><span class="o">*</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_REG_ADDR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">);</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">;</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">;</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ISR</span><span class="p">;</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="w"> </span><span class="n">stm32_tsc_start</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">);</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a><span class="w"> </span><span class="cm">/* this should timeout because sync pin is not triggered */</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="w"> </span><span class="n">zexpect_not_ok</span><span class="p">(</span><span class="n">stm32_tsc_poll_for_acquisition</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">,</span><span class="w"> </span><span class="n">K_MSEC</span><span class="p">(</span><span class="mi">100</span><span class="p">)));</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a><span class="w"> </span><span class="n">stm32_tsc_start</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">);</span>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a><span class="w"> </span><span class="n">zexpect_ok</span><span class="p">(</span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signal</span><span class="p">));</span>
</span><span id="__span-87-20"><a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a>
</span><span id="__span-87-21"><a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a><span class="w"> </span><span class="cm">/* check if interrupts are disabled */</span>
</span><span id="__span-87-22"><a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_IER_EOAIE_Msk</span><span class="p">);</span>
</span><span id="__span-87-23"><a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_IER_MCEIE_Msk</span><span class="p">);</span>
</span><span id="__span-87-24"><a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a>
</span><span id="__span-87-25"><a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a><span class="w"> </span><span class="cm">/* test CR register start bit */</span>
</span><span id="__span-87-26"><a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_START_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_START_Pos</span><span class="p">);</span>
</span><span id="__span-87-27"><a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>
</span><span id="__span-87-28"><a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a><span class="w"> </span><span class="n">zexpect_ok</span><span class="p">(</span><span class="n">stm32_tsc_poll_for_acquisition</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">,</span><span class="w"> </span><span class="n">K_MSEC</span><span class="p">(</span><span class="mi">100</span><span class="p">)));</span>
</span><span id="__span-87-29"><a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>
</span><span id="__span-87-30"><a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a><span class="w"> </span><span class="cm">/* test for max count error flag */</span>
</span><span id="__span-87-31"><a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_isr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF_Pos</span><span class="p">);</span>
</span><span id="__span-87-32"><a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>
</span><span id="__span-87-33"><a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
</span><span id="__span-87-34"><a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a><span class="w"> </span><span class="n">zexpect_ok</span><span class="p">(</span><span class="n">stm32_tsc_read</span><span class="p">(</span><span class="n">tsc_dev</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">));</span>
</span><span id="__span-87-35"><a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a><span class="p">}</span>
</span></code></pre></div>
<p>The next test will be to test the interrupt driven acquisition. This test will run only if the <code>CONFIG_STM32_TSC_INTERRUPT</code> is enabled.</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">static</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">tsc_input_received</span><span class="p">;</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">      </span><span class="nf">tsc_input_callback</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">input_event</span><span class="w"> </span><span class="o">*</span><span class="n">evt</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="p">{</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w"> </span><span class="n">ARG_UNUSED</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w"> </span><span class="n">ARG_UNUSED</span><span class="p">(</span><span class="n">user_data</span><span class="p">);</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w"> </span><span class="n">tsc_input_received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="p">}</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="n">INPUT_CALLBACK_DEFINE</span><span class="p">(</span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">),</span><span class="w"> </span><span class="n">tsc_input_callback</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="n">ZTEST</span><span class="p">(</span><span class="n">stm32_tsc</span><span class="p">,</span><span class="w"> </span><span class="n">test_5_acquisition_interrupt</span><span class="p">)</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="p">{</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="w"> </span><span class="n">Z_TEST_SKIP_IFNDEF</span><span class="p">(</span><span class="n">CONFIG_STM32_TSC_INTERRUPT</span><span class="p">);</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="w"> </span><span class="n">TSC_TypeDef</span><span class="w">  </span><span class="o">*</span><span class="n">tsc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TSC_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DT_REG_ADDR</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">);</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">CR</span><span class="p">;</span>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">;</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">tsc_isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsc</span><span class="o">-&gt;</span><span class="n">ISR</span><span class="p">;</span>
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a>
</span><span id="__span-88-21"><a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="w"> </span><span class="n">tsc_input_received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-88-22"><a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a>
</span><span id="__span-88-23"><a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a><span class="w"> </span><span class="n">stm32_tsc_start</span><span class="p">(</span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">TSC_NODE</span><span class="p">));</span>
</span><span id="__span-88-24"><a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a>
</span><span id="__span-88-25"><a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a><span class="w"> </span><span class="cm">/* test CR register start bit */</span>
</span><span id="__span-88-26"><a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_cr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_CR_START_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_CR_START_Pos</span><span class="p">);</span>
</span><span id="__span-88-27"><a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a>
</span><span id="__span-88-28"><a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a><span class="w"> </span><span class="cm">/* check if interrupts are enabled */</span>
</span><span id="__span-88-29"><a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_IER_EOAIE_Msk</span><span class="p">);</span>
</span><span id="__span-88-30"><a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">(</span><span class="o">*</span><span class="n">tsc_ier</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_IER_MCEIE_Msk</span><span class="p">);</span>
</span><span id="__span-88-31"><a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a>
</span><span id="__span-88-32"><a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a><span class="w"> </span><span class="n">k_sleep</span><span class="p">(</span><span class="n">K_MSEC</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
</span><span id="__span-88-33"><a id="__codelineno-88-33" name="__codelineno-88-33" href="#__codelineno-88-33"></a>
</span><span id="__span-88-34"><a id="__codelineno-88-34" name="__codelineno-88-34" href="#__codelineno-88-34"></a><span class="w"> </span><span class="cm">/* test ISR register max count error flag */</span>
</span><span id="__span-88-35"><a id="__codelineno-88-35" name="__codelineno-88-35" href="#__codelineno-88-35"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">((</span><span class="o">*</span><span class="n">tsc_isr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">TSC_ISR_MCEF_Pos</span><span class="p">);</span>
</span><span id="__span-88-36"><a id="__codelineno-88-36" name="__codelineno-88-36" href="#__codelineno-88-36"></a>
</span><span id="__span-88-37"><a id="__codelineno-88-37" name="__codelineno-88-37" href="#__codelineno-88-37"></a><span class="w"> </span><span class="cm">/* this should fail because of the sync pin */</span>
</span><span id="__span-88-38"><a id="__codelineno-88-38" name="__codelineno-88-38" href="#__codelineno-88-38"></a><span class="w"> </span><span class="n">zexpect_false</span><span class="p">(</span><span class="n">tsc_input_received</span><span class="p">);</span>
</span><span id="__span-88-39"><a id="__codelineno-88-39" name="__codelineno-88-39" href="#__codelineno-88-39"></a>
</span><span id="__span-88-40"><a id="__codelineno-88-40" name="__codelineno-88-40" href="#__codelineno-88-40"></a><span class="w"> </span><span class="n">zexpect_ok</span><span class="p">(</span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signal</span><span class="p">));</span>
</span><span id="__span-88-41"><a id="__codelineno-88-41" name="__codelineno-88-41" href="#__codelineno-88-41"></a>
</span><span id="__span-88-42"><a id="__codelineno-88-42" name="__codelineno-88-42" href="#__codelineno-88-42"></a><span class="w"> </span><span class="n">k_sleep</span><span class="p">(</span><span class="n">K_MSEC</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
</span><span id="__span-88-43"><a id="__codelineno-88-43" name="__codelineno-88-43" href="#__codelineno-88-43"></a>
</span><span id="__span-88-44"><a id="__codelineno-88-44" name="__codelineno-88-44" href="#__codelineno-88-44"></a><span class="w"> </span><span class="n">zexpect_true</span><span class="p">(</span><span class="n">tsc_input_received</span><span class="p">);</span>
</span><span id="__span-88-45"><a id="__codelineno-88-45" name="__codelineno-88-45" href="#__codelineno-88-45"></a><span class="p">}</span>
</span></code></pre></div>
<p>Here in this test a 100ms window is given to allow TSC peripheral to start acqusition and put the value to the input subsystem. The <code>tsc_input_callback</code> function is defined to set a flag when an input event is received.</p>
<p>Notice how we use <code>signal</code> and <code>gpio_pin_toggle_dt</code> to mock and test the presence and absence of an external trigger for the TSC peripheral.</p>
<h4 id="running-the-tests">Running the Tests</h4>
<p>We will use the west extension commands to use twistter and run the tests.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>west<span class="w"> </span>twister<span class="w"> </span>-T<span class="w"> </span>tests/drivers/misc/stm32_tsc<span class="w"> </span>--device-testing<span class="w"> </span>--device-serial<span class="w"> </span>COM4<span class="w"> </span>-p<span class="w"> </span>stm32u083c_dk
</span></code></pre></div>
<p>In this command we first select a specific test suite with <code>-T</code> flag, then we enable the device testing with <code>--device-testing</code> flag, and then we select the serial port with <code>--device-serial</code> flag and finally we select the board with <code>-p</code> flag, which stands for platform.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A physical connection with a jumper between PA10 and PD2 should be made before running the tests.</p>
</div>
<p>Twister will upload this and read the output from the serial port and let us know how it went. But for the fun of it, we can connect to the serial port with a terminal emulator and see the output.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>----<span class="w"> </span>Opened<span class="w"> </span>the<span class="w"> </span>serial<span class="w"> </span>port<span class="w"> </span>COM4<span class="w"> </span>----
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>***<span class="w"> </span>Booting<span class="w"> </span>Zephyr<span class="w"> </span>OS<span class="w"> </span>build<span class="w"> </span>6aae5648ff4d<span class="w"> </span>***
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>Running<span class="w"> </span>TESTSUITE<span class="w"> </span><span class="nv">stm32_tsc</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="o">===================================================================</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>START<span class="w"> </span>-<span class="w"> </span>test_1_device_ready
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span>test_1_device_ready<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="nv">seconds</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="o">===================================================================</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>START<span class="w"> </span>-<span class="w"> </span>test_2_cr_reg
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span>test_2_cr_reg<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="nv">seconds</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="o">===================================================================</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>START<span class="w"> </span>-<span class="w"> </span>test_3_group_registers
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a><span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span>test_3_group_registers<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="nv">seconds</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a><span class="o">===================================================================</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>START<span class="w"> </span>-<span class="w"> </span>test_4_acquisition_polling
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a><span class="w"> </span>SKIP<span class="w"> </span>-<span class="w"> </span>test_4_acquisition_polling<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="nv">seconds</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a><span class="o">===================================================================</span>
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>START<span class="w"> </span>-<span class="w"> </span>test_5_acquisition_interrupt
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a><span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span>test_5_acquisition_interrupt<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.201<span class="w"> </span><span class="nv">seconds</span>
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a><span class="o">===================================================================</span>
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>TESTSUITE<span class="w"> </span>stm32_tsc<span class="w"> </span>succeeded
</span><span id="__span-90-21"><a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>
</span><span id="__span-90-22"><a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>------<span class="w"> </span>TESTSUITE<span class="w"> </span>SUMMARY<span class="w"> </span>START<span class="w"> </span>------
</span><span id="__span-90-23"><a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>
</span><span id="__span-90-24"><a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>SUITE<span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span><span class="m">100</span>.00%<span class="w"> </span><span class="o">[</span>stm32_tsc<span class="o">]</span>:<span class="w"> </span><span class="nv">pass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="nv">fail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="nv">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="nv">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.205<span class="w"> </span>seconds
</span><span id="__span-90-25"><a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a><span class="w"> </span>-<span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span><span class="o">[</span>stm32_tsc.test_1_device_ready<span class="o">]</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span>seconds
</span><span id="__span-90-26"><a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a><span class="w"> </span>-<span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span><span class="o">[</span>stm32_tsc.test_2_cr_reg<span class="o">]</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span>seconds
</span><span id="__span-90-27"><a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a><span class="w"> </span>-<span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span><span class="o">[</span>stm32_tsc.test_3_group_registers<span class="o">]</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span>seconds
</span><span id="__span-90-28"><a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a><span class="w"> </span>-<span class="w"> </span>SKIP<span class="w"> </span>-<span class="w"> </span><span class="o">[</span>stm32_tsc.test_4_acquisition_polling<span class="o">]</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.001<span class="w"> </span>seconds
</span><span id="__span-90-29"><a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a><span class="w"> </span>-<span class="w"> </span>PASS<span class="w"> </span>-<span class="w"> </span><span class="o">[</span>stm32_tsc.test_5_acquisition_interrupt<span class="o">]</span><span class="w"> </span><span class="nv">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.201<span class="w"> </span>seconds
</span><span id="__span-90-30"><a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a>
</span><span id="__span-90-31"><a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a>------<span class="w"> </span>TESTSUITE<span class="w"> </span>SUMMARY<span class="w"> </span>END<span class="w"> </span>------
</span><span id="__span-90-32"><a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a>
</span><span id="__span-90-33"><a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a><span class="o">===================================================================</span>
</span><span id="__span-90-34"><a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>RunID:<span class="w"> </span>54191c69b895b72ac69c072ecf65e1d0
</span><span id="__span-90-35"><a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>PROJECT<span class="w"> </span>EXECUTION<span class="w"> </span>SUCCESSFUL
</span></code></pre></div>
<p>Looks like everything is working just fine. Perfect!</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>We've implemented the driver and tested it on the hardware. This is now complete as a driver but still not usable as is, in a future post I'll implement a library that uses this driver to generate input events that are usable (like actual press detection), instead of using the capture value and putting it in the input subsystem, which is not the ideal use of this subsystem at the moment.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>